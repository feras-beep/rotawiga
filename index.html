<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Neurosurgical Rota Management System</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }
        
        .header h1 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 2.5rem;
            font-weight: 300;
        }
        
        .header p {
            color: #7f8c8d;
            font-size: 1.1rem;
        }
        
        .upload-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 25px;
            border: 2px dashed #ddd;
            text-align: center;
            transition: all 0.3s ease;
        }
        
        .upload-section:hover {
            border-color: #667eea;
            background: #f0f4ff;
        }
        
        .file-input {
            margin: 15px 0;
            padding: 12px 25px;
            border: none;
            background: #667eea;
            color: white;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
        }
        
        .file-input:hover {
            background: #5a6fd8;
            transform: translateY(-2px);
        }
        
        .button {
            padding: 12px 25px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
            margin: 10px;
        }
        
        .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }
        
        .button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .results-section {
            margin-top: 25px;
        }
        
        .team-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .team-card {
            background: linear-gradient(135deg, #ffffff, #f8f9fa);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }
        
        .team-card:hover {
            transform: translateY(-5px);
        }
        
        .team-card h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.3rem;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 10px;
        }
        
        .doctor-list {
            list-style: none;
        }
        
        .doctor-list li {
            padding: 8px 12px;
            margin: 5px 0;
            background: #e8f4f8;
            border-radius: 8px;
            color: #2c3e50;
            font-weight: 500;
        }
        
        .preferred-doctor {
            background: #d4edda !important;
            border-left: 4px solid #28a745;
        }
        
        .alert {
            padding: 15px 20px;
            border-radius: 10px;
            margin: 15px 0;
            font-weight: 500;
        }
        
        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }
        
        .stat-card h4 {
            font-size: 0.9rem;
            opacity: 0.9;
            margin-bottom: 5px;
        }
        
        .stat-card .number {
            font-size: 2rem;
            font-weight: bold;
        }
        
        .export-section {
            margin-top: 25px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 15px;
            text-align: center;
        }
        
        .hidden {
            display: none;
        }
        
        .manual-input {
            background: #ffffff;
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
            border: 1px solid #e0e0e0;
        }
        
        .input-group {
            margin: 15px 0;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 5px;
            color: #2c3e50;
            font-weight: 500;
        }
        
        .input-group input, .input-group textarea {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
        }
        
        .input-group textarea {
            height: 100px;
            resize: vertical;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè• Neurosurgical Rota Manager</h1>
            <p>Automated weekly consultant team allocation system</p>
        </div>
        
        <div class="upload-section">
            <h3>üìÅ Upload Excel File</h3>
            <p>Select your weekly rota Excel file (will automatically find 'SHO Rota' sheet)</p>
            <input type="file" id="fileInput" accept=".xlsx,.xls" class="file-input">
            <div id="fileInfo" class="hidden"></div>
        </div>
        
        <div class="manual-input" id="manualInput">
            <h3>‚úèÔ∏è Manual Doctor Entry</h3>
            <p>If you don't have an Excel file, you can manually enter the available doctors:</p>
            <div class="input-group">
                <label for="doctorList">Available Doctors (one per line):</label>
                <textarea id="doctorList" placeholder="Munashe Veremu&#10;Hassan Bin Ajmal&#10;Michael Bandrivskyi&#10;George Hudson&#10;Sanchita Bhatia&#10;Suraj Sennik&#10;Danyal Khan FY1"></textarea>
            </div>
            <button class="button" onclick="processManualInput()">Process Manual Input</button>
        </div>
        
        <div class="button-group" style="text-align: center;">
            <button class="button" id="processBtn" onclick="processRota()" disabled>üîÑ Process Rota</button>
            <button class="button" onclick="generateSampleData()">üìù Use Sample Data</button>
        </div>
        
        <div id="results" class="results-section hidden">
            <div id="alerts"></div>
            
            <div class="stats-grid" id="statsGrid"></div>
            
            <div class="team-grid" id="teamGrid"></div>
            
            <div class="export-section">
                <button class="button" onclick="exportToExcel()">üìä Export to Excel</button>
                <button class="button" onclick="printRota()">üñ®Ô∏è Print Rota</button>
                <button class="button" onclick="copyAllMessages()">üìã Copy All Daily Messages</button>
            </div>
        </div>
    </div>

    <script>
        let currentDoctors = [];
        let currentAllocation = null;

        // Consultant team assignments and specialties
        const CONSULTANT_TEAMS = {
            'Pituitary + Epilepsy': {
                consultants: ['ND', 'HM', 'RB', 'AB', 'AWM', 'ANM'],
                requiredDoctors: 1,
                specialty: 'Pituitary + Epilepsy'
            },
            'Functional': {
                consultants: ['JH', 'HA', 'LZ', 'MK'],
                requiredDoctors: 2,
                specialty: 'Functional',
                subTeams: ['JH & HA', 'LZ & MK']
            },
            'Hydrocephalus': {
                consultants: ['AT', 'LW'],
                requiredDoctors: 1,
                specialty: 'Hydrocephalus'
            },
            'PG/WM': {
                consultants: ['PG', 'WM'],
                requiredDoctors: 1,
                specialty: 'PG/WM'
            },
            'PC/MM': {
                consultants: ['PC', 'MM'],
                requiredDoctors: 1,
                specialty: 'PC/MM'
            },
            'Team C': {
                consultants: ['CH', 'LT', 'NK', 'RM'],
                requiredDoctors: 3,
                specialty: 'Team C',
                includesFY1: true
            },
            'Team D': {
                consultants: ['Team D'],
                requiredDoctors: 2,
                specialty: 'Team D'
            }
        };

        // Special duty assignments
        const SPECIAL_DUTIES = {
            'Clerking Shift': 2,
            'On-call bleep': 1,
            'Second on-call': 1,
            'Night on-call': 1
        };

        // Team requirements (updated to match consultant structure)
        const TEAM_REQUIREMENTS = {
            'Pituitary + Epilepsy': 1,
            'Functional': 2,
            'Hydrocephalus': 1,
            'PG/WM': 1,
            'PC/MM': 1,
            'Team C': 3,
            'Team D': 2
        };

        // Preferred assignments (updated for consultant teams)
        const PREFERRED_ASSIGNMENTS = {
            'suraj': 'PC/MM',
            'sanchita': 'Night on-call',
            'george': 'Functional',
            'michael': 'Pituitary + Epilepsy',
            'sabrina': 'PG/WM',
            'oleksii': 'Hydrocephalus',
            'constantinos': 'Team C',
            'mohammed': 'Team D',
            'redwan': 'Team D'
        };

        document.getElementById('fileInput').addEventListener('change', handleFileSelect);

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                const fileInfo = document.getElementById('fileInfo');
                fileInfo.innerHTML = `<p>Selected: ${file.name}</p>`;
                fileInfo.classList.remove('hidden');
                document.getElementById('processBtn').disabled = false;
            }
        }

        function generateSampleData() {
            const sampleDoctors = [
                'Munashe Veremu', 'Hassan Bin Ajmal', 'Michael Bandrivskyi', 'Taha Albohassan', 
                'George Hudson', 'Sanchita Bhatia', 'Redwan Jabbar', 'Suraj Sennik', 
                'Hamza Salhab', 'Sandie Eiras', 'Oleksii Goncharuk', 'Shamimur Rahman',
                'Constantinos Thoma', 'Danyal Khan FY1', 'Sabrina Smith', 'Ioannis Koukoulithras',
                'Mohammed Lester', 'Saikat Ahmed'
            ];
            currentDoctors = sampleDoctors;
            document.getElementById('doctorList').value = sampleDoctors.join('\n');
            processAllocation();
        }

        function processManualInput() {
            const doctorText = document.getElementById('doctorList').value.trim();
            if (!doctorText) {
                showAlert('Please enter at least one doctor name', 'error');
                return;
            }
            
            currentDoctors = doctorText.split('\n')
                .map(name => name.trim())
                .filter(name => name.length > 0);
            
            processAllocation();
        }

        async function processRota() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            
            if (!file) {
                showAlert('Please select an Excel file first', 'error');
                return;
            }

            try {
                const arrayBuffer = await file.arrayBuffer();
                const workbook = XLSX.read(arrayBuffer);
                
                // Find the sho rota sheet - look for exact name match first
                let shoRotaSheet = workbook.SheetNames.find(name => 
                    name.toLowerCase() === 'sho rota'
                );
                
                // If not found, try other variations
                if (!shoRotaSheet) {
                    shoRotaSheet = workbook.SheetNames.find(name => 
                        name.toLowerCase().includes('sho') && name.toLowerCase().includes('rota')
                    ) || workbook.SheetNames.find(name => 
                        name.toLowerCase().includes('sho')
                    );
                }

                if (!shoRotaSheet) {
                    showAlert('Could not find "SHO Rota" sheet. Available sheets: ' + workbook.SheetNames.join(', '), 'error');
                    return;
                }

                const worksheet = workbook.Sheets[shoRotaSheet];
                const data = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: "" });
                
                // Extract doctor names (assuming they're in a column)
                currentDoctors = extractDoctorNames(data);
                
                console.log('Extracted doctors:', currentDoctors);
                console.log('Sheet found:', shoRotaSheet);
                
                if (currentDoctors.length === 0) {
                    showAlert('No doctor names found in the Excel file. Please check the format or try manual entry.', 'error');
                    // Show some sample data for debugging
                    console.log('Sample data from sheet:', data.slice(0, 10));
                    return;
                }

                showAlert(`‚úÖ Successfully extracted ${currentDoctors.length} doctors from "${shoRotaSheet}" sheet`, 'success');

                processAllocation();
                
            } catch (error) {
                showAlert('Error processing file: ' + error.message, 'error');
            }
        }

        function extractDoctorNames(data) {
            const doctors = [];
            let currentTeam = '';
            
            // Parse the specific Excel format we identified
            data.forEach((row, index) => {
                // Check if this row defines a team
                if (row[0] && row[0].toString().includes('Team ')) {
                    currentTeam = row[0].toString().trim();
                    
                    // If there's a doctor name in the same row (column B - index 1)
                    if (row[1] && row[1].toString().trim()) {
                        const doctorName = row[1].toString().trim();
                        if (!doctorName.includes('ADMISSIONS') && !doctorName.includes('‚Üí') && 
                            !doctorName.includes('Locum Cover')) {
                            doctors.push(doctorName);
                        }
                    }
                } 
                // Check for doctors in subsequent rows (where team column is empty but doctor name exists)
                else if ((!row[0] || row[0].toString().trim() === '') && currentTeam) {
                    if (row[1] && row[1].toString().trim()) {
                        const doctorName = row[1].toString().trim();
                        if (!doctorName.includes('ADMISSIONS') && !doctorName.includes('‚Üí') && 
                            !doctorName.includes('Locum Cover')) {
                            doctors.push(doctorName);
                        }
                    }
                }
            });
            
            // Remove duplicates and return
            return [...new Set(doctors)];
        }

        function processAllocation() {
            if (currentDoctors.length === 0) {
                showAlert('No doctors available for allocation', 'error');
                return;
            }

            // Filter out FY1 doctors
            const availableDoctors = currentDoctors.filter(doctor => 
                !doctor.toLowerCase().includes('fy1')
            );

            // Check if we have enough doctors
            const totalRequired = Object.values(TEAM_REQUIREMENTS).reduce((sum, req) => sum + req, 0);
            const needsLocum = availableDoctors.length < totalRequired;

            // Allocate doctors to teams
            const result = allocateDoctorsToTeams(availableDoctors);
            const allocation = result.allocation;
            const specialDuties = result.specialDuties;
            currentAllocation = { allocation, specialDuties };

            // Display results
            displayResults(allocation, specialDuties, needsLocum, availableDoctors.length, totalRequired);
        }

        function allocateDoctorsToTeams(doctors) {
            const allocation = {};
            const specialDuties = {};
            
            // Initialize allocation structure
            Object.keys(CONSULTANT_TEAMS).forEach(team => {
                allocation[team] = [];
            });
            
            Object.keys(SPECIAL_DUTIES).forEach(duty => {
                specialDuties[duty] = [];
            });

            const availableDoctors = [...doctors];
            const assigned = new Set();

            // First, assign preferred doctors to their preferred roles
            Object.entries(PREFERRED_ASSIGNMENTS).forEach(([doctorKey, preferredRole]) => {
                const doctor = availableDoctors.find(d => 
                    d.toLowerCase().includes(doctorKey.toLowerCase())
                );
                
                if (doctor && !assigned.has(doctor)) {
                    // Check if it's a special duty
                    if (SPECIAL_DUTIES[preferredRole] && specialDuties[preferredRole].length < SPECIAL_DUTIES[preferredRole]) {
                        specialDuties[preferredRole].push({
                            name: doctor,
                            preferred: true
                        });
                        assigned.add(doctor);
                    }
                    // Check if it's a consultant team
                    else if (CONSULTANT_TEAMS[preferredRole] && allocation[preferredRole].length < TEAM_REQUIREMENTS[preferredRole]) {
                        allocation[preferredRole].push({
                            name: doctor,
                            preferred: true
                        });
                        assigned.add(doctor);
                    }
                }
            });

            // Then assign remaining doctors to consultant teams
            const unassignedDoctors = availableDoctors.filter(d => !assigned.has(d));
            
            Object.entries(TEAM_REQUIREMENTS).forEach(([team, requirement]) => {
                while (allocation[team].length < requirement && unassignedDoctors.length > 0) {
                    const doctor = unassignedDoctors.shift();
                    allocation[team].push({
                        name: doctor,
                        preferred: false
                    });
                    assigned.add(doctor);
                }
            });

            // Fill remaining special duties
            Object.entries(SPECIAL_DUTIES).forEach(([duty, requirement]) => {
                while (specialDuties[duty].length < requirement && unassignedDoctors.length > 0) {
                    const doctor = unassignedDoctors.shift();
                    specialDuties[duty].push({
                        name: doctor,
                        preferred: false
                    });
                    assigned.add(doctor);
                }
            });

            return { allocation, specialDuties };
        }

        function displayResults(allocation, specialDuties, needsLocum, availableCount, requiredCount) {
            const resultsDiv = document.getElementById('results');
            const alertsDiv = document.getElementById('alerts');
            const statsGrid = document.getElementById('statsGrid');
            const teamGrid = document.getElementById('teamGrid');

            // Clear previous results
            alertsDiv.innerHTML = '';
            statsGrid.innerHTML = '';
            teamGrid.innerHTML = '';

            // Show alerts
            if (needsLocum) {
                const shortfall = requiredCount - availableCount;
                showAlert(`‚ö†Ô∏è LOCUM REQUIRED: You need ${shortfall} additional doctor${shortfall > 1 ? 's' : ''} to meet all team requirements`, 'warning');
            } else {
                showAlert('‚úÖ All teams can be adequately staffed with current doctors', 'success');
            }

            // Show stats
            const totalAssignments = Object.values(TEAM_REQUIREMENTS).reduce((sum, req) => sum + req, 0) + 
                                   Object.values(SPECIAL_DUTIES).reduce((sum, req) => sum + req, 0);
            
            statsGrid.innerHTML = `
                <div class="stat-card">
                    <h4>Available Doctors</h4>
                    <div class="number">${availableCount}</div>
                </div>
                <div class="stat-card">
                    <h4>Total Assignments</h4>
                    <div class="number">${totalAssignments}</div>
                </div>
                <div class="stat-card">
                    <h4>Consultant Teams</h4>
                    <div class="number">${Object.keys(CONSULTANT_TEAMS).length}</div>
                </div>
                <div class="stat-card">
                    <h4>Special Duties</h4>
                    <div class="number">${Object.keys(SPECIAL_DUTIES).length}</div>
                </div>
            `;

            // Show consultant team allocations
            Object.entries(allocation).forEach(([team, doctors]) => {
                const requirement = TEAM_REQUIREMENTS[team];
                const isUnderStaffed = doctors.length < requirement;
                const consultantInfo = CONSULTANT_TEAMS[team];
                
                const teamCard = document.createElement('div');
                teamCard.className = 'team-card';
                teamCard.innerHTML = `
                    <h3>${team} ${isUnderStaffed ? '‚ö†Ô∏è' : '‚úÖ'}</h3>
                    <p><strong>Consultants:</strong> ${consultantInfo.consultants.join(', ')}</p>
                    <p><strong>Required:</strong> ${requirement} | <strong>Assigned:</strong> ${doctors.length}</p>
                    <ul class="doctor-list">
                        ${doctors.map(doctor => `
                            <li class="${doctor.preferred ? 'preferred-doctor' : ''}">${doctor.name} ${doctor.preferred ? '‚≠ê' : ''}</li>
                        `).join('')}
                        ${isUnderStaffed ? '<li style="color: #e74c3c; font-style: italic;">‚ö†Ô∏è Needs locum coverage</li>' : ''}
                    </ul>
                `;
                teamGrid.appendChild(teamCard);
            });

            // Show special duties
            Object.entries(specialDuties).forEach(([duty, doctors]) => {
                const requirement = SPECIAL_DUTIES[duty];
                const isUnderStaffed = doctors.length < requirement;
                
                const dutyCard = document.createElement('div');
                dutyCard.className = 'team-card';
                dutyCard.style.background = 'linear-gradient(135deg, #ffeaa7, #fab1a0)';
                dutyCard.innerHTML = `
                    <h3>üîî ${duty} ${isUnderStaffed ? '‚ö†Ô∏è' : '‚úÖ'}</h3>
                    <p><strong>Required:</strong> ${requirement} | <strong>Assigned:</strong> ${doctors.length}</p>
                    <ul class="doctor-list">
                        ${doctors.map(doctor => `
                            <li class="${doctor.preferred ? 'preferred-doctor' : ''}">${doctor.name} ${doctor.preferred ? '‚≠ê' : ''}</li>
                        `).join('')}
                        ${isUnderStaffed ? '<li style="color: #e74c3c; font-style: italic;">‚ö†Ô∏è Needs coverage</li>' : ''}
                    </ul>
                `;
                teamGrid.appendChild(dutyCard);
            });

            // Add daily allocation message generator
            const messageCard = document.createElement('div');
            messageCard.className = 'team-card';
            messageCard.style.background = 'linear-gradient(135deg, #74b9ff, #0984e3)';
            messageCard.style.color = 'white';
            messageCard.innerHTML = `
                <h3>üìÖ Daily Allocation Message</h3>
                <div class="input-group" style="margin: 15px 0;">
                    <label for="dateInput" style="color: white;">Select Date:</label>
                    <input type="date" id="dateInput" value="${new Date().toISOString().split('T')[0]}" style="color: black;">
                </div>
                <button class="button" onclick="generateDailyMessage()" style="background: white; color: #0984e3;">üìù Generate Daily Message</button>
                <div id="dailyMessage" style="margin-top: 15px; padding: 15px; background: rgba(255,255,255,0.1); border-radius: 8px; font-family: monospace; white-space: pre-line; display: none;"></div>
            `;
            teamGrid.appendChild(messageCard);

            resultsDiv.classList.remove('hidden');
        }

        function showAlert(message, type) {
            const alertsDiv = document.getElementById('alerts');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.innerHTML = message;
            alertsDiv.appendChild(alert);
        }

        function generateDailyMessage() {
            if (!currentAllocation) {
                showAlert('No allocation data available. Please process a rota first.', 'error');
                return;
            }

            const dateInput = document.getElementById('dateInput');
            const selectedDate = new Date(dateInput.value);
            const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            const dayName = dayNames[selectedDate.getDay()];
            const formattedDate = selectedDate.toLocaleDateString('en-GB', { 
                day: '2-digit', 
                month: '2-digit', 
                year: '2-digit' 
            });

            const message = generateDailyMessageText(formattedDate, dayName);

            // Display the message
            const messageDiv = document.getElementById('dailyMessage');
            messageDiv.textContent = message;
            messageDiv.style.display = 'block';

            // Add copy button functionality
            messageDiv.onclick = function() {
                navigator.clipboard.writeText(message).then(() => {
                    showAlert('‚úÖ Daily message copied to clipboard!', 'success');
                });
            };
        }

        function generateDailyMessageText(formattedDate, dayName) {
            const allocation = currentAllocation.allocation;
            const specialDuties = currentAllocation.specialDuties;

            // Get day of week (0 = Sunday, 1 = Monday, etc.)
            const date = new Date(formattedDate.split('/').reverse().join('-'));
            const dayOfWeek = date.getDay();

            let message = `SHO Team allocations for ${formattedDate} ${dayName}\n\n`;

            // Create rotated assignments based on day of week
            const rotatedAllocation = rotateAssignments(allocation, specialDuties, dayOfWeek);

            // Generate consultant team assignments
            let counter = 1;
            
            // Pituitary + Epilepsy
            if (rotatedAllocation['Pituitary + Epilepsy'] && rotatedAllocation['Pituitary + Epilepsy'].length > 0) {
                const doctor = rotatedAllocation['Pituitary + Epilepsy'][0].split(' ')[0];
                message += `${counter}. Pituitary + Epilepsy (ND/HM/RB/AB & AWM/ANM) - ${doctor}\n`;
                counter++;
            }

            // Functional
            if (rotatedAllocation['Functional'] && rotatedAllocation['Functional'].length > 0) {
                message += `${counter}. Functional:\n`;
                rotatedAllocation['Functional'].forEach((doctor, index) => {
                    const firstName = doctor.split(' ')[0];
                    const consultants = index === 0 ? '(JH & HA)' : '(LZ & MK)';
                    message += `      ${firstName}${consultants}\n`;
                });
                counter++;
            }

            // Hydrocephalus
            if (rotatedAllocation['Hydrocephalus'] && rotatedAllocation['Hydrocephalus'].length > 0) {
                const doctor = rotatedAllocation['Hydrocephalus'][0].split(' ')[0];
                message += `${counter}. Hydrocephalus (AT/LW) - ${doctor}\n`;
                counter++;
            }

            // PG/WM
            if (rotatedAllocation['PG/WM'] && rotatedAllocation['PG/WM'].length > 0) {
                const doctor = rotatedAllocation['PG/WM'][0].split(' ')[0];
                message += `${counter}. PG/WM - ${doctor}\n`;
                counter++;
            }

            // PC/MM
            if (rotatedAllocation['PC/MM'] && rotatedAllocation['PC/MM'].length > 0) {
                const doctor = rotatedAllocation['PC/MM'][0].split(' ')[0];
                message += `${counter}. PC/MM - ${doctor}\n`;
                counter++;
            }

            // Team C
            if (rotatedAllocation['Team C'] && rotatedAllocation['Team C'].length > 0) {
                message += `${counter}. Team C:\n`;
                rotatedAllocation['Team C'].forEach((doctor, index) => {
                    const firstName = doctor.split(' ')[0];
                    let consultantInfo = '';
                    if (index === 0) consultantInfo = ' (CH)';
                    else if (index === 1) consultantInfo = '(LT & NK)';
                    else if (doctor.toLowerCase().includes('fy1')) consultantInfo = ' (RM)';
                    
                    message += `   ${firstName}${consultantInfo}\n`;
                });
                counter++;
            }

            // Team D
            if (rotatedAllocation['Team D'] && rotatedAllocation['Team D'].length > 0) {
                const doctors = rotatedAllocation['Team D'].map(d => d.split(' ')[0]).join(' & ');
                message += `${counter}. Team D - ${doctors}\n`;
            }

            // Special duties (also rotated)
            message += '\n';
            
            if (rotatedAllocation['Clerking Shift'] && rotatedAllocation['Clerking Shift'].length > 0) {
                const doctors = rotatedAllocation['Clerking Shift'].map(d => d.split(' ')[0].toLowerCase()).join(', ');
                message += `Clerking Shift: ${doctors}\n`;
            }

            if (rotatedAllocation['On-call bleep'] && rotatedAllocation['On-call bleep'].length > 0) {
                const doctor = rotatedAllocation['On-call bleep'][0].split(' ')[0].toLowerCase();
                message += `On-call bleep: ${doctor}\n`;
            }

            if (rotatedAllocation['Second on-call'] && rotatedAllocation['Second on-call'].length > 0) {
                const doctor = rotatedAllocation['Second on-call'][0].split(' ')[0].toLowerCase();
                message += `Second on-call: ${doctor}\n`;
            }

            if (rotatedAllocation['Night on-call'] && rotatedAllocation['Night on-call'].length > 0) {
                const doctor = rotatedAllocation['Night on-call'][0].split(' ')[0];
                message += `Night on-call: ${doctor}`;
            }

            return message;
        }

        function rotateAssignments(allocation, specialDuties, dayOffset) {
            const rotated = {};
            
            // Get all available doctors from all teams
            const allDoctors = [];
            Object.values(allocation).forEach(team => {
                team.forEach(doctor => {
                    if (!doctor.name.toLowerCase().includes('fy1')) {
                        allDoctors.push(doctor.name);
                    }
                });
            });
            Object.values(specialDuties).forEach(duty => {
                duty.forEach(doctor => {
                    if (!doctor.name.toLowerCase().includes('fy1') && !allDoctors.includes(doctor.name)) {
                        allDoctors.push(doctor.name);
                    }
                });
            });

            // Find FY1 doctors separately
            const fy1Doctors = [];
            Object.values(allocation).forEach(team => {
                team.forEach(doctor => {
                    if (doctor.name.toLowerCase().includes('fy1')) {
                        fy1Doctors.push(doctor.name);
                    }
                });
            });

            // Rotate the doctor pool based on day
            const rotatedDoctors = [...allDoctors];
            for (let i = 0; i < dayOffset; i++) {
                rotatedDoctors.push(rotatedDoctors.shift());
            }

            let doctorIndex = 0;

            // Assign rotated doctors to teams
            Object.entries(TEAM_REQUIREMENTS).forEach(([team, requirement]) => {
                rotated[team] = [];
                for (let i = 0; i < requirement && doctorIndex < rotatedDoctors.length; i++) {
                    rotated[team].push(rotatedDoctors[doctorIndex]);
                    doctorIndex++;
                }
                
                // Add FY1 to Team C if needed
                if (team === 'Team C' && fy1Doctors.length > 0) {
                    rotated[team].push(fy1Doctors[0]);
                }
            });

            // Assign to special duties
            Object.entries(SPECIAL_DUTIES).forEach(([duty, requirement]) => {
                rotated[duty] = [];
                for (let i = 0; i < requirement && doctorIndex < rotatedDoctors.length; i++) {
                    rotated[duty].push(rotatedDoctors[doctorIndex]);
                    doctorIndex++;
                }
            });

            return rotated;
        }

        function copyAllMessages() {
            if (!currentAllocation) {
                showAlert('No allocation data available. Please process a rota first.', 'error');
                return;
            }

            const today = new Date();
            const monday = new Date(today);
            monday.setDate(today.getDate() - today.getDay() + 1); // Get Monday of current week

            let allMessages = '';
            const daysOfWeek = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];

            for (let i = 0; i < 7; i++) {
                const currentDate = new Date(monday);
                currentDate.setDate(monday.getDate() + i);
                
                const dayName = daysOfWeek[i];
                const formattedDate = currentDate.toLocaleDateString('en-GB', { 
                    day: '2-digit', 
                    month: '2-digit', 
                    year: '2-digit' 
                });

                allMessages += generateDailyMessageText(formattedDate, dayName);
                if (i < 6) allMessages += '\n' + '='.repeat(50) + '\n\n';
            }

            navigator.clipboard.writeText(allMessages).then(() => {
                showAlert('‚úÖ All weekly messages copied to clipboard!', 'success');
            });
        }

        function exportToExcel() {
            if (!currentAllocation) {
                showAlert('No allocation data to export', 'error');
                return;
            }

            const ws_data = [
                ['Assignment Type', 'Team/Duty', 'Doctor', 'Consultants', 'Preferred Assignment']
            ];

            // Add consultant team assignments
            Object.entries(currentAllocation.allocation).forEach(([team, doctors]) => {
                const consultants = CONSULTANT_TEAMS[team]?.consultants.join(', ') || '';
                doctors.forEach(doctor => {
                    ws_data.push(['Consultant Team', team, doctor.name, consultants, doctor.preferred ? 'Yes' : 'No']);
                });
                
                // Add empty rows for missing positions
                const requirement = TEAM_REQUIREMENTS[team];
                for (let i = doctors.length; i < requirement; i++) {
                    ws_data.push(['Consultant Team', team, 'LOCUM NEEDED', consultants, 'No']);
                }
            });

            // Add special duties
            Object.entries(currentAllocation.specialDuties).forEach(([duty, doctors]) => {
                doctors.forEach(doctor => {
                    ws_data.push(['Special Duty', duty, doctor.name, '', doctor.preferred ? 'Yes' : 'No']);
                });
                
                // Add empty rows for missing positions
                const requirement = SPECIAL_DUTIES[duty];
                for (let i = doctors.length; i < requirement; i++) {
                    ws_data.push(['Special Duty', duty, 'COVERAGE NEEDED', '', 'No']);
                }
            });

            const ws = XLSX.utils.aoa_to_sheet(ws_data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Consultant Rota Allocation');

            const filename = `Neurosurgical_Consultant_Rota_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, filename);
        }

        function printRota() {
            if (!currentAllocation) {
                showAlert('No allocation data to print', 'error');
                return;
            }

            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                <head>
                    <title>Neurosurgical Consultant Rota</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        .header { text-align: center; margin-bottom: 30px; }
                        .team { margin-bottom: 20px; page-break-inside: avoid; }
                        .team h3 { background: #f0f0f0; padding: 10px; margin: 0; }
                        .team ul { list-style: none; padding: 10px; margin: 0; border: 1px solid #ddd; }
                        .team li { padding: 5px 0; }
                        .preferred { font-weight: bold; }
                        .special-duty { background: #fff3cd; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>Neurosurgical Consultant Rota</h1>
                        <p>Week Commencing: ${new Date().toLocaleDateString()}</p>
                    </div>
                    
                    <h2>Consultant Teams</h2>
                    ${Object.entries(currentAllocation.allocation).map(([team, doctors]) => `
                        <div class="team">
                            <h3>${team} (${doctors.length}/${TEAM_REQUIREMENTS[team]})</h3>
                            <p><strong>Consultants:</strong> ${CONSULTANT_TEAMS[team]?.consultants.join(', ') || ''}</p>
                            <ul>
                                ${doctors.map(doctor => `
                                    <li class="${doctor.preferred ? 'preferred' : ''}">${doctor.name}</li>
                                `).join('')}
                            </ul>
                        </div>
                    `).join('')}
                    
                    <h2>Special Duties</h2>
                    ${Object.entries(currentAllocation.specialDuties).map(([duty, doctors]) => `
                        <div class="team special-duty">
                            <h3>${duty} (${doctors.length}/${SPECIAL_DUTIES[duty]})</h3>
                            <ul>
                                ${doctors.map(doctor => `
                                    <li class="${doctor.preferred ? 'preferred' : ''}">${doctor.name}</li>
                                `).join('')}
                            </ul>
                        </div>
                    `).join('')}
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }
    </script>
</body>
</html>
