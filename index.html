<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Neurosurgical Rota Management System</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }
        
        .header h1 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 2.5rem;
            font-weight: 300;
        }
        
        .header p {
            color: #7f8c8d;
            font-size: 1.1rem;
        }
        
        .upload-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 25px;
            border: 2px dashed #ddd;
            text-align: center;
            transition: all 0.3s ease;
        }
        
        .upload-section:hover {
            border-color: #667eea;
            background: #f0f4ff;
        }
        
        .file-input {
            margin: 15px 0;
            padding: 12px 25px;
            border: none;
            background: #667eea;
            color: white;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
        }
        
        .file-input:hover {
            background: #5a6fd8;
            transform: translateY(-2px);
        }
        
        .button {
            padding: 12px 25px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
            margin: 10px;
        }
        
        .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }
        
        .button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .results-section {
            margin-top: 25px;
        }
        
        .team-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .team-card {
            background: linear-gradient(135deg, #ffffff, #f8f9fa);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }
        
        .team-card:hover {
            transform: translateY(-5px);
        }
        
        .team-card h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.3rem;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 10px;
        }
        
        .doctor-list {
            list-style: none;
        }
        
        .doctor-list li {
            padding: 8px 12px;
            margin: 5px 0;
            background: #e8f4f8;
            border-radius: 8px;
            color: #2c3e50;
            font-weight: 500;
        }
        
        .preferred-doctor {
            background: #d4edda !important;
            border-left: 4px solid #28a745;
        }
        
        .alert {
            padding: 15px 20px;
            border-radius: 10px;
            margin: 15px 0;
            font-weight: 500;
        }
        
        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }
        
        .stat-card h4 {
            font-size: 0.9rem;
            opacity: 0.9;
            margin-bottom: 5px;
        }
        
        .stat-card .number {
            font-size: 2rem;
            font-weight: bold;
        }
        
        .export-section {
            margin-top: 25px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 15px;
            text-align: center;
        }
        
        .hidden {
            display: none;
        }
        
        .manual-input {
            background: #ffffff;
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
            border: 1px solid #e0e0e0;
        }
        
        .input-group {
            margin: 15px 0;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 5px;
            color: #2c3e50;
            font-weight: 500;
        }
        
        .input-group input, .input-group textarea {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
        }
        
        .input-group textarea {
            height: 100px;
            resize: vertical;
        }
        
        .day-nav-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 20px 0;
            padding: 15px;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
        }
        
        .day-nav-button {
            padding: 10px 20px;
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 20px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
        }
        
        .day-nav-button:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
        }
        
        .current-day-info {
            text-align: center;
            font-size: 1.2rem;
            font-weight: bold;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè• Neurosurgical Rota Manager</h1>
            <p>Automated weekly consultant team allocation system</p>
        </div>
        
        <div class="upload-section">
            <h3>üìÅ Upload Excel File</h3>
            <p>Select your weekly rota Excel file (will automatically find 'SHO Rota' sheet)</p>
            <input type="file" id="fileInput" accept=".xlsx,.xls" class="file-input">
            <div id="fileInfo" class="hidden"></div>
        </div>
        
        <div class="manual-input" id="manualInput">
            <h3>‚úèÔ∏è Manual Doctor Entry</h3>
            <p>If you don't have an Excel file, you can manually enter the available doctors:</p>
            <div class="input-group">
                <label for="doctorList">Available Doctors (one per line):</label>
                <textarea id="doctorList" placeholder="Munashe Veremu&#10;Hassan Bin Ajmal&#10;Michael Bandrivskyi&#10;George Hudson&#10;Sanchita Bhatia&#10;Suraj Sennik&#10;Danyal Khan FY1"></textarea>
            </div>
            <button class="button" onclick="processManualInput()">Process Manual Input</button>
        </div>
        
        <div class="button-group" style="text-align: center;">
            <button class="button" id="processBtn" onclick="processRota()" disabled>üîÑ Process Rota</button>
            <button class="button" onclick="generateSampleData()">üìù Use Sample Data</button>
        </div>
        
        <div id="results" class="results-section hidden">
            <div id="alerts"></div>
            
            <div class="stats-grid" id="statsGrid"></div>
            
            <div class="team-grid" id="teamGrid"></div>
            
            <div class="export-section">
                <button class="button" onclick="exportToExcel()">üìä Export to Excel</button>
                <button class="button" onclick="printRota()">üñ®Ô∏è Print Rota</button>
                <button class="button" onclick="copyAllMessages()">üìã Copy All Weekday Messages (Mon-Fri)</button>
            </div>
        </div>
    </div>

    <script>
        let currentDoctors = [];
        let currentAllocation = null;
        let weekStartDate = new Date('2025-08-18');
        let currentDayIndex = 0;

        const CONSULTANT_TEAMS = {
            'Pituitary + Epilepsy': {
                consultants: ['ND', 'HM', 'RB', 'AB', 'AWM', 'ANM'],
                requiredDoctors: 1,
                specialty: 'Pituitary + Epilepsy'
            },
            'Functional': {
                consultants: ['JH', 'HA', 'LZ', 'MK'],
                requiredDoctors: 2,
                specialty: 'Functional',
                subTeams: ['JH & HA', 'LZ & MK']
            },
            'Hydrocephalus': {
                consultants: ['AT', 'LW'],
                requiredDoctors: 1,
                specialty: 'Hydrocephalus'
            },
            'PG/WM': {
                consultants: ['PG', 'WM'],
                requiredDoctors: 1,
                specialty: 'PG/WM'
            },
            'PC/MM': {
                consultants: ['PC', 'MM'],
                requiredDoctors: 1,
                specialty: 'PC/MM'
            },
            'Team C': {
                consultants: ['CH', 'LT', 'NK', 'RM'],
                requiredDoctors: 3,
                specialty: 'Team C',
                includesFY1: true
            },
            'Team D': {
                consultants: ['Team D'],
                requiredDoctors: 2,
                specialty: 'Team D'
            }
        };

        const SPECIAL_DUTIES = {
            'Clerking Shift': 2,
            'On-call bleep': 1,
            'Second on-call': 1,
            'Night on-call': 1
        };

        const TEAM_REQUIREMENTS = {
            'Pituitary + Epilepsy': 1,
            'Functional': 2,
            'Hydrocephalus': 1,
            'PG/WM': 1,
            'PC/MM': 1,
            'Team C': 3,
            'Team D': 2
        };

        const PREFERRED_ASSIGNMENTS = {
            'suraj': 'PC/MM',
            'sanchita': 'Night on-call',
            'george': 'Functional',
            'michael': 'Pituitary + Epilepsy',
            'sabrina': 'PG/WM',
            'oleksii': 'Hydrocephalus',
            'constantinos': 'Team C',
            'mohammed': 'Team D',
            'redwan': 'Team D'
        };

        document.getElementById('fileInput').addEventListener('change', handleFileSelect);

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                const fileInfo = document.getElementById('fileInfo');
                fileInfo.innerHTML = `<p>Selected: ${file.name}</p>`;
                fileInfo.classList.remove('hidden');
                document.getElementById('processBtn').disabled = false;
            }
        }

        function generateSampleData() {
            const sampleDoctors = [
                'Munashe Veremu', 'Hassan Bin Ajmal', 'Michael Bandrivskyi', 'Taha Albohassan', 
                'George Hudson', 'Sanchita Bhatia', 'Redwan Jabbar', 'Suraj Sennik', 
                'Hamza Salhab', 'Sandie Eiras', 'Oleksii Goncharuk', 'Shamimur Rahman',
                'Constantinos Thoma', 'Danyal Khan FY1', 'Sabrina Smith', 'Ioannis Koukoulithras',
                'Mohammed Lester', 'Saikat Ahmed'
            ];
            currentDoctors = sampleDoctors;
            document.getElementById('doctorList').value = sampleDoctors.join('\n');
            processAllocation();
        }

        function processManualInput() {
            const doctorText = document.getElementById('doctorList').value.trim();
            if (!doctorText) {
                showAlert('Please enter at least one doctor name', 'error');
                return;
            }
            
            currentDoctors = doctorText.split('\n')
                .map(name => name.trim())
                .filter(name => name.length > 0);
            
            processAllocation();
        }

        async function processRota() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            
            if (!file) {
                showAlert('Please select an Excel file first', 'error');
                return;
            }

            try {
                const arrayBuffer = await file.arrayBuffer();
                const workbook = XLSX.read(arrayBuffer);
                
                let shoRotaSheet = workbook.SheetNames.find(name => 
                    name.toLowerCase() === 'sho rota'
                );
                
                if (!shoRotaSheet) {
                    shoRotaSheet = workbook.SheetNames.find(name => 
                        name.toLowerCase().includes('sho') && name.toLowerCase().includes('rota')
                    ) || workbook.SheetNames.find(name => 
                        name.toLowerCase().includes('sho')
                    );
                }

                if (!shoRotaSheet) {
                    showAlert('Could not find "SHO Rota" sheet. Available sheets: ' + workbook.SheetNames.join(', '), 'error');
                    return;
                }

                const worksheet = workbook.Sheets[shoRotaSheet];
                const data = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: "" });
                
                currentDoctors = extractDoctorNames(data);
                
                console.log('Extracted doctors:', currentDoctors);
                console.log('Sheet found:', shoRotaSheet);
                
                if (currentDoctors.length === 0) {
                    showAlert('No doctor names found in the Excel file. Please check the format or try manual entry.', 'error');
                    console.log('Sample data from sheet:', data.slice(0, 10));
                    return;
                }

                showAlert(`‚úÖ Successfully extracted ${currentDoctors.length} doctors from "${shoRotaSheet}" sheet`, 'success');
                processAllocation();
                
            } catch (error) {
                showAlert('Error processing file: ' + error.message, 'error');
            }
        }

        function extractDoctorNames(data) {
            const doctors = [];
            let currentTeam = '';
            
            // Extract week starting date from the Excel file
            const weekCommencingRow = data.find(row => 
                row[0] && row[0].toString().toLowerCase().includes('w/c')
            );
            
            if (weekCommencingRow) {
                const dateMatch = weekCommencingRow[0].match(/(\d{1,2}(?:st|nd|rd|th)?\s+\w+\s+\d{4})/i);
                if (dateMatch) {
                    try {
                        const dateStr = dateMatch[1].replace(/(\d+)(st|nd|rd|th)/, '$1');
                        const parsedDate = new Date(dateStr);
                        if (!isNaN(parsedDate.getTime())) {
                            weekStartDate = parsedDate;
                            console.log('Extracted week start date:', weekStartDate.toDateString());
                        }
                    } catch (e) {
                        console.log('Could not parse date, using default');
                    }
                }
            }
            
            // Parse the specific Excel format and extract actual shift data
            data.forEach((row, index) => {
                // Check if this row defines a team
                if (row[0] && row[0].toString().includes('Team ')) {
                    currentTeam = row[0].toString().trim();
                    
                    // If there's a doctor name in the same row (column B - index 1)
                    if (row[1] && row[1].toString().trim()) {
                        const doctorName = row[1].toString().trim();
                        if (!doctorName.includes('ADMISSIONS') && !doctorName.includes('‚Üí') && 
                            !doctorName.includes('Locum Cover')) {
                            doctors.push({
                                name: doctorName,
                                team: currentTeam,
                                firm: row[2] || '',
                                shifts: {
                                    monday: row[4] || '',
                                    tuesday: row[5] || '',
                                    wednesday: row[6] || '',
                                    thursday: row[7] || '',
                                    friday: row[8] || ''
                                }
                            });
                        }
                    }
                } 
                // Check for doctors in subsequent rows
                else if ((!row[0] || row[0].toString().trim() === '') && currentTeam) {
                    if (row[1] && row[1].toString().trim()) {
                        const doctorName = row[1].toString().trim();
                        if (!doctorName.includes('ADMISSIONS') && !doctorName.includes('‚Üí') && 
                            !doctorName.includes('Locum Cover')) {
                            doctors.push({
                                name: doctorName,
                                team: currentTeam,
                                firm: row[2] || '',
                                shifts: {
                                    monday: row[4] || '',
                                    tuesday: row[5] || '',
                                    wednesday: row[6] || '',
                                    thursday: row[7] || '',
                                    friday: row[8] || ''
                                }
                            });
                        }
                    }
                }
            });
            
            // Return just doctor names for compatibility, but store full data
            window.doctorShiftData = doctors; // Store for later use
            return [...new Set(doctors.map(d => d.name))];
        }

        function processAllocation() {
            if (currentDoctors.length === 0) {
                showAlert('No doctors available for allocation', 'error');
                return;
            }

            const availableDoctors = currentDoctors.filter(doctor => 
                !doctor.toLowerCase().includes('fy1')
            );

            const totalRequired = Object.values(TEAM_REQUIREMENTS).reduce((sum, req) => sum + req, 0);
            const needsLocum = availableDoctors.length < totalRequired;

            const result = allocateDoctorsToTeams(availableDoctors);
            const allocation = result.allocation;
            const specialDuties = result.specialDuties;
            currentAllocation = { allocation, specialDuties };

            displayResults(allocation, specialDuties, needsLocum, availableDoctors.length, totalRequired);
        }

        function allocateDoctorsToTeams(doctors) {
            const allocation = {};
            const specialDuties = {};
            
            Object.keys(CONSULTANT_TEAMS).forEach(team => {
                allocation[team] = [];
            });
            
            Object.keys(SPECIAL_DUTIES).forEach(duty => {
                specialDuties[duty] = [];
            });

            const availableDoctors = [...doctors];
            const assigned = new Set();

            Object.entries(PREFERRED_ASSIGNMENTS).forEach(([doctorKey, preferredRole]) => {
                const doctor = availableDoctors.find(d => 
                    d.toLowerCase().includes(doctorKey.toLowerCase())
                );
                
                if (doctor && !assigned.has(doctor)) {
                    if (SPECIAL_DUTIES[preferredRole] && specialDuties[preferredRole].length < SPECIAL_DUTIES[preferredRole]) {
                        specialDuties[preferredRole].push({
                            name: doctor,
                            preferred: true
                        });
                        assigned.add(doctor);
                    }
                    else if (CONSULTANT_TEAMS[preferredRole] && allocation[preferredRole].length < TEAM_REQUIREMENTS[preferredRole]) {
                        allocation[preferredRole].push({
                            name: doctor,
                            preferred: true
                        });
                        assigned.add(doctor);
                    }
                }
            });

            const unassignedDoctors = availableDoctors.filter(d => !assigned.has(d));
            
            Object.entries(TEAM_REQUIREMENTS).forEach(([team, requirement]) => {
                while (allocation[team].length < requirement && unassignedDoctors.length > 0) {
                    const doctor = unassignedDoctors.shift();
                    allocation[team].push({
                        name: doctor,
                        preferred: false
                    });
                    assigned.add(doctor);
                }
            });

            Object.entries(SPECIAL_DUTIES).forEach(([duty, requirement]) => {
                while (specialDuties[duty].length < requirement && unassignedDoctors.length > 0) {
                    const doctor = unassignedDoctors.shift();
                    specialDuties[duty].push({
                        name: doctor,
                        preferred: false
                    });
                    assigned.add(doctor);
                }
            });

            return { allocation, specialDuties };
        }

        function displayResults(allocation, specialDuties, needsLocum, availableCount, requiredCount) {
            const resultsDiv = document.getElementById('results');
            const alertsDiv = document.getElementById('alerts');
            const statsGrid = document.getElementById('statsGrid');
            const teamGrid = document.getElementById('teamGrid');

            alertsDiv.innerHTML = '';
            statsGrid.innerHTML = '';
            teamGrid.innerHTML = '';

            if (needsLocum) {
                const shortfall = requiredCount - availableCount;
                showAlert(`‚ö†Ô∏è LOCUM REQUIRED: You need ${shortfall} additional doctor${shortfall > 1 ? 's' : ''} to meet all team requirements`, 'warning');
            } else {
                showAlert('‚úÖ All teams can be adequately staffed with current doctors', 'success');
            }

            const totalAssignments = Object.values(TEAM_REQUIREMENTS).reduce((sum, req) => sum + req, 0) + 
                                   Object.values(SPECIAL_DUTIES).reduce((sum, req) => sum + req, 0);
            
            statsGrid.innerHTML = `
                <div class="stat-card">
                    <h4>Available Doctors</h4>
                    <div class="number">${availableCount}</div>
                </div>
                <div class="stat-card">
                    <h4>Total Assignments</h4>
                    <div class="number">${totalAssignments}</div>
                </div>
                <div class="stat-card">
                    <h4>Consultant Teams</h4>
                    <div class="number">${Object.keys(CONSULTANT_TEAMS).length}</div>
                </div>
                <div class="stat-card">
                    <h4>Special Duties</h4>
                    <div class="number">${Object.keys(SPECIAL_DUTIES).length}</div>
                </div>
            `;

            Object.entries(allocation).forEach(([team, doctors]) => {
                const requirement = TEAM_REQUIREMENTS[team];
                const isUnderStaffed = doctors.length < requirement;
                const consultantInfo = CONSULTANT_TEAMS[team];
                
                const teamCard = document.createElement('div');
                teamCard.className = 'team-card';
                teamCard.innerHTML = `
                    <h3>${team} ${isUnderStaffed ? '‚ö†Ô∏è' : '‚úÖ'}</h3>
                    <p><strong>Consultants:</strong> ${consultantInfo.consultants.join(', ')}</p>
                    <p><strong>Required:</strong> ${requirement} | <strong>Assigned:</strong> ${doctors.length}</p>
                    <ul class="doctor-list">
                        ${doctors.map(doctor => `
                            <li class="${doctor.preferred ? 'preferred-doctor' : ''}">${doctor.name}</li>
                        `).join('')}
                        ${isUnderStaffed ? '<li style="color: #e74c3c; font-style: italic;">‚ö†Ô∏è Needs locum coverage</li>' : ''}
                    </ul>
                `;
                teamGrid.appendChild(teamCard);
            });

            Object.entries(specialDuties).forEach(([duty, doctors]) => {
                const requirement = SPECIAL_DUTIES[duty];
                const isUnderStaffed = doctors.length < requirement;
                
                const dutyCard = document.createElement('div');
                dutyCard.className = 'team-card';
                dutyCard.style.background = 'linear-gradient(135deg, #ffeaa7, #fab1a0)';
                dutyCard.innerHTML = `
                    <h3>üîî ${duty} ${isUnderStaffed ? '‚ö†Ô∏è' : '‚úÖ'}</h3>
                    <p><strong>Required:</strong> ${requirement} | <strong>Assigned:</strong> ${doctors.length}</p>
                    <ul class="doctor-list">
                        ${doctors.map(doctor => `
                            <li class="${doctor.preferred ? 'preferred-doctor' : ''}">${doctor.name}</li>
                        `).join('')}
                        ${isUnderStaffed ? '<li style="color: #e74c3c; font-style: italic;">‚ö†Ô∏è Needs coverage</li>' : ''}
                    </ul>
                `;
                teamGrid.appendChild(dutyCard);
            });

            const dayNavCard = document.createElement('div');
            dayNavCard.className = 'team-card';
            dayNavCard.style.background = 'linear-gradient(135deg, #6c5ce7, #a29bfe)';
            dayNavCard.style.color = 'white';
            dayNavCard.innerHTML = `
                <h3>üìÖ Weekday Rota Navigator (Mon-Fri)</h3>
                <div style="display: flex; justify-content: space-between; align-items: center; margin: 20px 0;">
                    <button class="button" onclick="previousDay()" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3);">‚óÄ Previous</button>
                    <div id="currentDayDisplay" style="text-align: center; font-size: 1.2rem; font-weight: bold;"></div>
                    <button class="button" onclick="nextDay()" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3);">Next ‚ñ∂</button>
                </div>
                <div style="display: flex; justify-content: center; gap: 10px; margin: 15px 0; flex-wrap: wrap;">
                    <button class="button" onclick="goToDay(0)" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); font-size: 0.9rem;">Mon</button>
                    <button class="button" onclick="goToDay(1)" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); font-size: 0.9rem;">Tue</button>
                    <button class="button" onclick="goToDay(2)" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); font-size: 0.9rem;">Wed</button>
                    <button class="button" onclick="goToDay(3)" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); font-size: 0.9rem;">Thu</button>
                    <button class="button" onclick="goToDay(4)" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); font-size: 0.9rem;">Fri</button>
                </div>
                <div id="currentDayAllocation" style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px; font-family: monospace; white-space: pre-line; font-size: 0.9rem;"></div>
                <button class="button" onclick="copyCurrentDay()" style="background: white; color: #6c5ce7; margin-top: 10px;">üìã Copy Today's Message</button>
            `;
            teamGrid.appendChild(dayNavCard);

            const messageCard = document.createElement('div');
            messageCard.className = 'team-card';
            messageCard.style.background = 'linear-gradient(135deg, #74b9ff, #0984e3)';
            messageCard.style.color = 'white';
            messageCard.innerHTML = `
                <h3>üìÖ Custom Date Message</h3>
                <div class="input-group" style="margin: 15px 0;">
                    <label for="dateInput" style="color: white;">Select Custom Date:</label>
                    <input type="date" id="dateInput" value="${new Date().toISOString().split('T')[0]}" style="color: black;">
                </div>
                <button class="button" onclick="generateDailyMessage()" style="background: white; color: #0984e3;">üìù Generate Custom Message</button>
                <div id="dailyMessage" style="margin-top: 15px; padding: 15px; background: rgba(255,255,255,0.1); border-radius: 8px; font-family: monospace; white-space: pre-line; display: none;"></div>
            `;
            teamGrid.appendChild(messageCard);

            updateCurrentDayDisplay();
            resultsDiv.classList.remove('hidden');
        }

        function updateCurrentDayDisplay() {
            const currentDate = new Date(weekStartDate);
            currentDate.setDate(weekStartDate.getDate() + currentDayIndex);
            
            const dayNames = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'];
            const dayName = dayNames[currentDayIndex % 5];
            const formattedDate = currentDate.toLocaleDateString('en-GB', { 
                day: '2-digit', 
                month: '2-digit', 
                year: '2-digit' 
            });

            const displayDiv = document.getElementById('currentDayDisplay');
            if (displayDiv) {
                displayDiv.innerHTML = `${dayName}<br>${formattedDate}`;
            }

            const allocationDiv = document.getElementById('currentDayAllocation');
            if (allocationDiv && currentAllocation) {
                const message = generateDailyMessageText(formattedDate, dayName);
                allocationDiv.textContent = message;
                
                // Update the team cards display to match current day
                updateTeamCardsForCurrentDay();
            }

            // Update day button highlighting
            const dayButtons = document.querySelectorAll('[onclick^="goToDay"]');
            dayButtons.forEach((button, index) => {
                if (index === currentDayIndex) {
                    button.style.background = 'rgba(255,255,255,0.4)';
                    button.style.fontWeight = 'bold';
                } else {
                    button.style.background = 'rgba(255,255,255,0.2)';
                    button.style.fontWeight = 'normal';
                }
            });
        }

        function updateTeamCardsForCurrentDay() {
            if (!window.currentDayTeamAllocation) return;

            const teamGrid = document.getElementById('teamGrid');
            if (!teamGrid) return;

            // Find and update existing team cards (not the navigation cards)
            const teamCards = Array.from(teamGrid.children).filter(card => 
                card.innerHTML.includes('Consultants:') && 
                !card.innerHTML.includes('Daily Rota Navigator') &&
                !card.innerHTML.includes('Custom Date Message')
            );

            teamCards.forEach(card => {
                const teamName = card.querySelector('h3').textContent.split(' ')[0] + 
                               (card.querySelector('h3').textContent.includes('+') ? ' + ' + 
                                card.querySelector('h3').textContent.split(' + ')[1].split(' ')[0] : '');
                
                const fullTeamName = teamName === 'Pituitary' ? 'Pituitary + Epilepsy' : teamName;
                
                if (window.currentDayTeamAllocation[fullTeamName]) {
                    const doctors = window.currentDayTeamAllocation[fullTeamName];
                    const requirement = TEAM_REQUIREMENTS[fullTeamName] || 1;
                    const isUnderStaffed = doctors.length < requirement;
                    const consultantInfo = CONSULTANT_TEAMS[fullTeamName];
                    
                    // Update the card content
                    card.innerHTML = `
                        <h3>${fullTeamName} ${isUnderStaffed ? '‚ö†Ô∏è' : '‚úÖ'}</h3>
                        <p><strong>Consultants:</strong> ${consultantInfo ? consultantInfo.consultants.join(', ') : ''}</p>
                        <p><strong>Required:</strong> ${requirement} | <strong>Assigned:</strong> ${doctors.length}</p>
                        <ul class="doctor-list">
                            ${doctors.map(doctor => `
                                <li class="${doctor.preferred ? 'preferred-doctor' : ''}">${doctor.name}</li>
                            `).join('')}
                            ${isUnderStaffed ? '<li style="color: #e74c3c; font-style: italic;">‚ö†Ô∏è Needs locum coverage</li>' : ''}
                        </ul>
                    `;
                }
            });
        }

        function previousDay() {
            currentDayIndex = (currentDayIndex - 1 + 5) % 5;
            updateCurrentDayDisplay();
        }

        function nextDay() {
            currentDayIndex = (currentDayIndex + 1) % 5;
            updateCurrentDayDisplay();
        }

        function goToDay(dayIndex) {
            currentDayIndex = dayIndex;
            updateCurrentDayDisplay();
        }

        function copyCurrentDay() {
            const allocationDiv = document.getElementById('currentDayAllocation');
            if (allocationDiv && allocationDiv.textContent) {
                navigator.clipboard.writeText(allocationDiv.textContent).then(() => {
                    showAlert('‚úÖ Current day message copied to clipboard!', 'success');
                });
            } else {
                showAlert('No allocation data to copy', 'error');
            }
        }

        function showAlert(message, type) {
            const alertsDiv = document.getElementById('alerts');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.innerHTML = message;
            alertsDiv.appendChild(alert);
        }

        function generateDailyMessage() {
            if (!currentAllocation) {
                showAlert('No allocation data available. Please process a rota first.', 'error');
                return;
            }

            const dateInput = document.getElementById('dateInput');
            const selectedDate = new Date(dateInput.value);
            const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            const dayName = dayNames[selectedDate.getDay()];
            const formattedDate = selectedDate.toLocaleDateString('en-GB', { 
                day: '2-digit', 
                month: '2-digit', 
                year: '2-digit' 
            });

            const message = generateDailyMessageText(formattedDate, dayName);

            const messageDiv = document.getElementById('dailyMessage');
            messageDiv.textContent = message;
            messageDiv.style.display = 'block';

            messageDiv.onclick = function() {
                navigator.clipboard.writeText(message).then(() => {
                    showAlert('‚úÖ Daily message copied to clipboard!', 'success');
                });
            };
        }

        function generateDailyMessageText(formattedDate, dayName) {
            if (!window.doctorShiftData) {
                return generateRotatedDailyMessage(formattedDate, dayName);
            }

            const dayNames = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'];
            const dayKey = dayName.toLowerCase();
            
            let message = `SHO Team allocations for ${formattedDate} ${dayName}\n\n`;

            // Get doctors working this day (including clerking shifts)
            const availableToday = window.doctorShiftData.filter(doctor => {
                const shift = doctor.shifts[dayKey] || '';
                const upperShift = shift.toUpperCase();
                return shift && 
                       !upperShift.includes('AL') && 
                       !upperShift.includes('ZERO') && 
                       !upperShift.includes('SL') && 
                       !upperShift.includes('WEISS') &&
                       !upperShift.includes('NIGHT');
            });

            // Get special duty assignments for this day
            const clerkingShifts = window.doctorShiftData.filter(doctor => {
                const shift = doctor.shifts[dayKey] || '';
                return shift.startsWith('0700-') || shift.startsWith('07');
            });

            const ldBleeps = window.doctorShiftData.filter(doctor => {
                const shift = doctor.shifts[dayKey] || '';
                return shift.toUpperCase().includes('LD BLEEP');
            });

            const ldSeconds = window.doctorShiftData.filter(doctor => {
                const shift = doctor.shifts[dayKey] || '';
                return shift.toUpperCase().includes('LD SECOND');
            });

            const nightShifts = window.doctorShiftData.filter(doctor => {
                const shift = doctor.shifts[dayKey] || '';
                return shift.toUpperCase().includes('NIGHT');
            });

            // Always assign Suraj to PC/MM if available
            const surajDoctor = availableToday.find(d => d.name.toLowerCase().includes('suraj'));
            
            // Initialize all teams with empty arrays
            const teamAllocations = {
                'Pituitary + Epilepsy': [],
                'Functional': [],
                'Hydrocephalus': [],
                'PG/WM': [],
                'PC/MM': surajDoctor ? [surajDoctor] : [],
                'Team C': [],
                'Team D': []
            };

            // Remove Suraj from available pool if assigned to PC/MM
            const remainingDoctors = surajDoctor ? 
                availableToday.filter(d => !d.name.toLowerCase().includes('suraj')) : 
                availableToday;

            // Assign doctors to their primary teams based on firm codes
            remainingDoctors.forEach(doctor => {
                const firm = doctor.firm.toUpperCase();
                
                if (['ND', 'HM', 'RB', 'AB', 'AWM', 'ANM'].some(code => firm.includes(code))) {
                    teamAllocations['Pituitary + Epilepsy'].push(doctor);
                } else if (['LZ', 'JH', 'HA', 'MK'].some(code => firm.includes(code))) {
                    teamAllocations['Functional'].push(doctor);
                } else if (['AT', 'LW'].some(code => firm.includes(code))) {
                    teamAllocations['Hydrocephalus'].push(doctor);
                } else if (['PG', 'WM'].some(code => firm.includes(code))) {
                    teamAllocations['PG/WM'].push(doctor);
                } else if (['PC', 'MM'].some(code => firm.includes(code)) && !surajDoctor) {
                    teamAllocations['PC/MM'].push(doctor);
                } else if (['HS', 'NK', 'RO', 'RM', 'CH', 'LT'].some(code => firm.includes(code))) {
                    teamAllocations['Team C'].push(doctor);
                } else if (['PS', 'JA', 'NZ', 'DC', 'VR', 'AR', 'ATC', 'GP'].some(code => firm.includes(code))) {
                    teamAllocations['Team D'].push(doctor);
                } else {
                    // Unassigned doctors - distribute to teams that need help
                    teamAllocations['Team C'].push(doctor);
                }
            });

            // Ensure every team has at least one person - redistribute if needed
            const teamPriority = ['Pituitary + Epilepsy', 'Functional', 'Hydrocephalus', 'PG/WM', 'PC/MM', 'Team C', 'Team D'];
            const unassignedPool = [];
            
            // Collect extra doctors from overstaffed teams
            Object.entries(teamAllocations).forEach(([teamName, doctors]) => {
                if (['Functional', 'Team C', 'Team D'].includes(teamName)) {
                    // These teams can have multiple people
                    return;
                }
                if (doctors.length > 1) {
                    unassignedPool.push(...doctors.splice(1)); // Keep only 1 for specialist teams
                }
            });

            // Fill empty teams first
            teamPriority.forEach(teamName => {
                if (teamAllocations[teamName].length === 0 && unassignedPool.length > 0) {
                    teamAllocations[teamName].push(unassignedPool.shift());
                }
            });

            // If still empty teams and available doctors, assign from larger teams
            teamPriority.forEach(teamName => {
                if (teamAllocations[teamName].length === 0) {
                    // Find a team with multiple people to borrow from
                    const donorTeam = Object.entries(teamAllocations).find(([name, doctors]) => 
                        doctors.length > 1 && ['Team C', 'Team D', 'Functional'].includes(name)
                    );
                    if (donorTeam) {
                        teamAllocations[teamName].push(donorTeam[1].pop());
                    }
                }
            });

            // Store current day allocation for the team display
            window.currentDayTeamAllocation = teamAllocations;

            let counter = 1;

            // Generate team assignments
            Object.entries(teamAllocations).forEach(([teamName, doctors]) => {
                if (doctors.length > 0) {
                    if (teamName === 'Functional') {
                        message += `${counter}. Functional:\n`;
                        doctors.forEach((doctor, index) => {
                            const firstName = doctor.name.split(' ')[0];
                            const consultants = index === 0 ? '(JH & HA)' : '(LZ & MK)';
                            message += `      ${firstName}${consultants}\n`;
                        });
                    } else if (teamName === 'Team C') {
                        message += `${counter}. Team C:\n`;
                        doctors.forEach((doctor, index) => {
                            const firstName = doctor.name.split(' ')[0];
                            let consultantInfo = '';
                            if (doctor.firm.includes('CH')) consultantInfo = ' (CH)';
                            else if (doctor.firm.includes('LT') || doctor.firm.includes('NK')) consultantInfo = '(LT & NK)';
                            else if (doctor.name.toLowerCase().includes('fy1') || doctor.firm.includes('RM')) consultantInfo = ' (RM)';
                            
                            message += `   ${firstName}${consultantInfo}\n`;
                        });
                    } else if (teamName === 'Team D') {
                        const doctorNames = doctors.map(d => d.name.split(' ')[0]).join(' & ');
                        message += `${counter}. Team D - ${doctorNames}\n`;
                    } else {
                        const firstName = doctors[0].name.split(' ')[0];
                        const consultantCodes = {
                            'Pituitary + Epilepsy': '(ND/HM/RB/AB & AWM/ANM)',
                            'Hydrocephalus': '(AT/LW)',
                            'PG/WM': '',
                            'PC/MM': ''
                        };
                        message += `${counter}. ${teamName} ${consultantCodes[teamName] || ''} - ${firstName}\n`;
                    }
                    counter++;
                }
            });

            // Add special duties
            message += '\n';
            
            if (clerkingShifts.length > 0) {
                const doctors = clerkingShifts.map(d => d.name.split(' ')[0].toLowerCase()).join(', ');
                message += `Clerking Shift: ${doctors}\n`;
            }

            if (ldBleeps.length > 0) {
                const doctor = ldBleeps[0].name.split(' ')[0].toLowerCase();
                message += `On-call bleep: ${doctor}\n`;
            }

            if (ldSeconds.length > 0) {
                const doctor = ldSeconds[0].name.split(' ')[0].toLowerCase();
                message += `Second on-call: ${doctor}\n`;
            }

            if (nightShifts.length > 0) {
                const doctor = nightShifts[0].name.split(' ')[0];
                message += `Night on-call: ${doctor}`;
            }

            return message;
        }

        function generateRotatedDailyMessage(formattedDate, dayName) {
            // Fallback rotation system when no Excel shift data available
            const allocation = currentAllocation.allocation;
            const specialDuties = currentAllocation.specialDuties;

            const dayNames = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'];
            const dayOffset = dayNames.indexOf(dayName);

            let message = `SHO Team allocations for ${formattedDate} ${dayName}\n\n`;

            const rotatedAllocation = rotateAssignments(allocation, specialDuties, dayOffset);

            let counter = 1;
            
            if (rotatedAllocation['Pituitary + Epilepsy'] && rotatedAllocation['Pituitary + Epilepsy'].length > 0) {
                const doctor = rotatedAllocation['Pituitary + Epilepsy'][0].split(' ')[0];
                message += `${counter}. Pituitary + Epilepsy (ND/HM/RB/AB & AWM/ANM) - ${doctor}\n`;
                counter++;
            }

            if (rotatedAllocation['Functional'] && rotatedAllocation['Functional'].length > 0) {
                message += `${counter}. Functional:\n`;
                rotatedAllocation['Functional'].forEach((doctor, index) => {
                    const firstName = doctor.split(' ')[0];
                    const consultants = index === 0 ? '(JH & HA)' : '(LZ & MK)';
                    message += `      ${firstName}${consultants}\n`;
                });
                counter++;
            }

            if (rotatedAllocation['Hydrocephalus'] && rotatedAllocation['Hydrocephalus'].length > 0) {
                const doctor = rotatedAllocation['Hydrocephalus'][0].split(' ')[0];
                message += `${counter}. Hydrocephalus (AT/LW) - ${doctor}\n`;
                counter++;
            }

            if (rotatedAllocation['PG/WM'] && rotatedAllocation['PG/WM'].length > 0) {
                const doctor = rotatedAllocation['PG/WM'][0].split(' ')[0];
                message += `${counter}. PG/WM - ${doctor}\n`;
                counter++;
            }

            if (rotatedAllocation['PC/MM'] && rotatedAllocation['PC/MM'].length > 0) {
                const doctor = rotatedAllocation['PC/MM'][0].split(' ')[0];
                message += `${counter}. PC/MM - ${doctor}\n`;
                counter++;
            }

            if (rotatedAllocation['Team C'] && rotatedAllocation['Team C'].length > 0) {
                message += `${counter}. Team C:\n`;
                rotatedAllocation['Team C'].forEach((doctor, index) => {
                    const firstName = doctor.split(' ')[0];
                    let consultantInfo = '';
                    if (index === 0) consultantInfo = ' (CH)';
                    else if (index === 1) consultantInfo = '(LT & NK)';
                    else if (doctor.toLowerCase().includes('fy1')) consultantInfo = ' (RM)';
                    
                    message += `   ${firstName}${consultantInfo}\n`;
                });
                counter++;
            }

            if (rotatedAllocation['Team D'] && rotatedAllocation['Team D'].length > 0) {
                const doctors = rotatedAllocation['Team D'].map(d => d.split(' ')[0]).join(' & ');
                message += `${counter}. Team D - ${doctors}\n`;
            }

            message += '\n';
            
            if (rotatedAllocation['Clerking Shift'] && rotatedAllocation['Clerking Shift'].length > 0) {
                const doctors = rotatedAllocation['Clerking Shift'].map(d => d.split(' ')[0].toLowerCase()).join(', ');
                message += `Clerking Shift: ${doctors}\n`;
            }

            if (rotatedAllocation['On-call bleep'] && rotatedAllocation['On-call bleep'].length > 0) {
                const doctor = rotatedAllocation['On-call bleep'][0].split(' ')[0].toLowerCase();
                message += `On-call bleep: ${doctor}\n`;
            }

            if (rotatedAllocation['Second on-call'] && rotatedAllocation['Second on-call'].length > 0) {
                const doctor = rotatedAllocation['Second on-call'][0].split(' ')[0].toLowerCase();
                message += `Second on-call: ${doctor}\n`;
            }

            if (rotatedAllocation['Night on-call'] && rotatedAllocation['Night on-call'].length > 0) {
                const doctor = rotatedAllocation['Night on-call'][0].split(' ')[0];
                message += `Night on-call: ${doctor}`;
            }

            return message;
        }

        function rotateAssignments(allocation, specialDuties, dayOffset) {
            const rotated = {};
            
            const allDoctors = [];
            Object.values(allocation).forEach(team => {
                team.forEach(doctor => {
                    if (!doctor.name.toLowerCase().includes('fy1')) {
                        allDoctors.push(doctor.name);
                    }
                });
            });
            Object.values(specialDuties).forEach(duty => {
                duty.forEach(doctor => {
                    if (!doctor.name.toLowerCase().includes('fy1') && !allDoctors.includes(doctor.name)) {
                        allDoctors.push(doctor.name);
                    }
                });
            });

            const fy1Doctors = [];
            Object.values(allocation).forEach(team => {
                team.forEach(doctor => {
                    if (doctor.name.toLowerCase().includes('fy1')) {
                        fy1Doctors.push(doctor.name);
                    }
                });
            });

            const rotatedDoctors = [...allDoctors];
            for (let i = 0; i < dayOffset; i++) {
                rotatedDoctors.push(rotatedDoctors.shift());
            }

            let doctorIndex = 0;

            Object.entries(TEAM_REQUIREMENTS).forEach(([team, requirement]) => {
                rotated[team] = [];
                for (let i = 0; i < requirement && doctorIndex < rotatedDoctors.length; i++) {
                    rotated[team].push(rotatedDoctors[doctorIndex]);
                    doctorIndex++;
                }
                
                if (team === 'Team C' && fy1Doctors.length > 0) {
                    rotated[team].push(fy1Doctors[0]);
                }
            });

            Object.entries(SPECIAL_DUTIES).forEach(([duty, requirement]) => {
                rotated[duty] = [];
                for (let i = 0; i < requirement && doctorIndex < rotatedDoctors.length; i++) {
                    rotated[duty].push(rotatedDoctors[doctorIndex]);
                    doctorIndex++;
                }
            });

            return rotated;
        }

        function copyAllMessages() {
            if (!currentAllocation) {
                showAlert('No allocation data available. Please process a rota first.', 'error');
                return;
            }

            let allMessages = '';
            const daysOfWeek = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'];

            for (let i = 0; i < 5; i++) {
                const currentDate = new Date(weekStartDate);
                currentDate.setDate(weekStartDate.getDate() + i);
                
                const dayName = daysOfWeek[i];
                const formattedDate = currentDate.toLocaleDateString('en-GB', { 
                    day: '2-digit', 
                    month: '2-digit', 
                    year: '2-digit' 
                });

                allMessages += generateDailyMessageText(formattedDate, dayName);
                if (i < 4) allMessages += '\n' + '='.repeat(50) + '\n\n';
            }

            navigator.clipboard.writeText(allMessages).then(() => {
                showAlert('‚úÖ All weekday messages (Mon-Fri) copied to clipboard!', 'success');
            });
        }

        function exportToExcel() {
            if (!currentAllocation) {
                showAlert('No allocation data to export', 'error');
                return;
            }

            const ws_data = [
                ['Assignment Type', 'Team/Duty', 'Doctor', 'Consultants', 'Preferred Assignment']
            ];

            Object.entries(currentAllocation.allocation).forEach(([team, doctors]) => {
                const consultants = CONSULTANT_TEAMS[team]?.consultants.join(', ') || '';
                doctors.forEach(doctor => {
                    ws_data.push(['Consultant Team', team, doctor.name, consultants, doctor.preferred ? 'Yes' : 'No']);
                });
                
                const requirement = TEAM_REQUIREMENTS[team];
                for (let i = doctors.length; i < requirement; i++) {
                    ws_data.push(['Consultant Team', team, 'LOCUM NEEDED', consultants, 'No']);
                }
            });

            Object.entries(currentAllocation.specialDuties).forEach(([duty, doctors]) => {
                doctors.forEach(doctor => {
                    ws_data.push(['Special Duty', duty, doctor.name, '', doctor.preferred ? 'Yes' : 'No']);
                });
                
                const requirement = SPECIAL_DUTIES[duty];
                for (let i = doctors.length; i < requirement; i++) {
                    ws_data.push(['Special Duty', duty, 'COVERAGE NEEDED', '', 'No']);
                }
            });

            const ws = XLSX.utils.aoa_to_sheet(ws_data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Consultant Rota Allocation');

            const filename = `Neurosurgical_Consultant_Rota_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, filename);
        }

        function printRota() {
            if (!currentAllocation) {
                showAlert('No allocation data to print', 'error');
                return;
            }

            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                <head>
                    <title>Neurosurgical Consultant Rota</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        .header { text-align: center; margin-bottom: 30px; }
                        .team { margin-bottom: 20px; page-break-inside: avoid; }
                        .team h3 { background: #f0f0f0; padding: 10px; margin: 0; }
                        .team ul { list-style: none; padding: 10px; margin: 0; border: 1px solid #ddd; }
                        .team li { padding: 5px 0; }
                        .preferred { font-weight: bold; }
                        .special-duty { background: #fff3cd; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>Neurosurgical Consultant Rota</h1>
                        <p>Week Commencing: ${weekStartDate.toLocaleDateString()}</p>
                    </div>
                    
                    <h2>Consultant Teams</h2>
                    ${Object.entries(currentAllocation.allocation).map(([team, doctors]) => `
                        <div class="team">
                            <h3>${team} (${doctors.length}/${TEAM_REQUIREMENTS[team]})</h3>
                            <p><strong>Consultants:</strong> ${CONSULTANT_TEAMS[team]?.consultants.join(', ') || ''}</p>
                            <ul>
                                ${doctors.map(doctor => `
                                    <li class="${doctor.preferred ? 'preferred' : ''}">${doctor.name}</li>
                                `).join('')}
                            </ul>
                        </div>
                    `).join('')}
                    
                    <h2>Special Duties</h2>
                    ${Object.entries(currentAllocation.specialDuties).map(([duty, doctors]) => `
                        <div class="team special-duty">
                            <h3>${duty} (${doctors.length}/${SPECIAL_DUTIES[duty]})</h3>
                            <ul>
                                ${doctors.map(doctor => `
                                    <li class="${doctor.preferred ? 'preferred' : ''}">${doctor.name}</li>
                                `).join('')}
                            </ul>
                        </div>
                    `).join('')}
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }
    </script>
</body>
</html>
