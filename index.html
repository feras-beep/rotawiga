<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Neurosurgical Rota Management System</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }
        
        .header h1 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 2.5rem;
            font-weight: 300;
        }
        
        .header p {
            color: #7f8c8d;
            font-size: 1.1rem;
        }
        
        .upload-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 25px;
            border: 2px dashed #ddd;
            text-align: center;
            transition: all 0.3s ease;
        }
        
        .upload-section:hover {
            border-color: #667eea;
            background: #f0f4ff;
        }
        
        .file-input {
            margin: 15px 0;
            padding: 12px 25px;
            border: none;
            background: #667eea;
            color: white;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
        }
        
        .file-input:hover {
            background: #5a6fd8;
            transform: translateY(-2px);
        }
        
        .button {
            padding: 12px 25px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
            margin: 10px;
        }
        
        .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }
        
        .button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .results-section {
            margin-top: 25px;
        }
        
        .team-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .team-card {
            background: linear-gradient(135deg, #ffffff, #f8f9fa);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }
        
        .team-card:hover {
            transform: translateY(-5px);
        }
        
        .team-card h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.3rem;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 10px;
        }
        
        .doctor-list {
            list-style: none;
        }
        
        .doctor-list li {
            padding: 8px 12px;
            margin: 5px 0;
            background: #e8f4f8;
            border-radius: 8px;
            color: #2c3e50;
            font-weight: 500;
        }
        
        .preferred-doctor {
            background: #d4edda !important;
            border-left: 4px solid #28a745;
        }
        
        .alert {
            padding: 15px 20px;
            border-radius: 10px;
            margin: 15px 0;
            font-weight: 500;
        }
        
        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }
        
        .stat-card h4 {
            font-size: 0.9rem;
            opacity: 0.9;
            margin-bottom: 5px;
        }
        
        .stat-card .number {
            font-size: 2rem;
            font-weight: bold;
        }
        
        .export-section {
            margin-top: 25px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 15px;
            text-align: center;
        }
        
        .hidden {
            display: none;
        }
        
        .manual-input {
            background: #ffffff;
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
            border: 1px solid #e0e0e0;
        }
        
        .input-group {
            margin: 15px 0;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 5px;
            color: #2c3e50;
            font-weight: 500;
        }
        
        .input-group input, .input-group textarea {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
        }
        
        .input-group textarea {
            height: 100px;
            resize: vertical;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè• Neurosurgical Rota Manager</h1>
            <p>Automated weekly rota allocation system</p>
        </div>
        
        <div class="upload-section">
            <h3>üìÅ Upload Excel File</h3>
            <p>Select your weekly rota Excel file (must contain 'sho rota' sheet)</p>
            <input type="file" id="fileInput" accept=".xlsx,.xls" class="file-input">
            <div id="fileInfo" class="hidden"></div>
        </div>
        
        <div class="manual-input" id="manualInput">
            <h3>‚úèÔ∏è Manual Doctor Entry</h3>
            <p>If you don't have an Excel file, you can manually enter the available doctors:</p>
            <div class="input-group">
                <label for="doctorList">Available Doctors (one per line):</label>
                <textarea id="doctorList" placeholder="Munashe Veremu&#10;Hassan Bin Ajmal&#10;Michael Bandrivskyi&#10;George Hudson&#10;Sanchita Bhatia&#10;Suraj Sennik&#10;Danyal Khan FY1"></textarea>
            </div>
            <button class="button" onclick="processManualInput()">Process Manual Input</button>
        </div>
        
        <div class="button-group" style="text-align: center;">
            <button class="button" id="processBtn" onclick="processRota()" disabled>üîÑ Process Rota</button>
            <button class="button" onclick="generateSampleData()">üìù Use Sample Data</button>
        </div>
        
        <div id="results" class="results-section hidden">
            <div id="alerts"></div>
            
            <div class="stats-grid" id="statsGrid"></div>
            
            <div class="team-grid" id="teamGrid"></div>
            
            <div class="export-section">
                <button class="button" onclick="exportToExcel()">üìä Export to Excel</button>
                <button class="button" onclick="printRota()">üñ®Ô∏è Print Rota</button>
            </div>
        </div>
    </div>

    <script>
        let currentDoctors = [];
        let currentAllocation = null;

        // Team requirements
        const TEAM_REQUIREMENTS = {
            'Team A': 2,
            'Team B': 3,
            'Team C': 1,
            'Team D': 1
        };

        // Preferred assignments
        const PREFERRED_ASSIGNMENTS = {
            'suraj': 'Team B',
            'sanchita': 'Team B',
            'george': 'Team A',
            'feras': 'Team D'  // Note: Feras may not always be available
        };

        document.getElementById('fileInput').addEventListener('change', handleFileSelect);

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                const fileInfo = document.getElementById('fileInfo');
                fileInfo.innerHTML = `<p>Selected: ${file.name}</p>`;
                fileInfo.classList.remove('hidden');
                document.getElementById('processBtn').disabled = false;
            }
        }

        function generateSampleData() {
            const sampleDoctors = [
                'Munashe Veremu', 'Hassan Bin Ajmal', 'Michael Bandrivskyi', 'Taha Albohassan', 
                'George Hudson', 'Sanchita Bhatia', 'Redwan Jabbar', 'Suraj Sennik', 
                'Hamza Salhab', 'Sandie Eiras', 'Oleksii Goncharuk', 'Shamimur Rahman',
                'Constantinos Thoma', 'Danyal Khan FY1', 'Sabrina Smith', 'Ioannis Koukoulithras'
            ];
            currentDoctors = sampleDoctors;
            document.getElementById('doctorList').value = sampleDoctors.join('\n');
            processAllocation();
        }

        function processManualInput() {
            const doctorText = document.getElementById('doctorList').value.trim();
            if (!doctorText) {
                showAlert('Please enter at least one doctor name', 'error');
                return;
            }
            
            currentDoctors = doctorText.split('\n')
                .map(name => name.trim())
                .filter(name => name.length > 0);
            
            processAllocation();
        }

        async function processRota() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            
            if (!file) {
                showAlert('Please select an Excel file first', 'error');
                return;
            }

            try {
                const arrayBuffer = await file.arrayBuffer();
                const workbook = XLSX.read(arrayBuffer);
                
                // Find the sho rota sheet - look for exact name match first
                let shoRotaSheet = workbook.SheetNames.find(name => 
                    name.toLowerCase() === 'sho rota'
                );
                
                // If not found, try other variations
                if (!shoRotaSheet) {
                    shoRotaSheet = workbook.SheetNames.find(name => 
                        name.toLowerCase().includes('sho') && name.toLowerCase().includes('rota')
                    ) || workbook.SheetNames.find(name => 
                        name.toLowerCase().includes('sho')
                    );
                }

                if (!shoRotaSheet) {
                    showAlert('Could not find "SHO Rota" sheet. Available sheets: ' + workbook.SheetNames.join(', '), 'error');
                    return;
                }

                const worksheet = workbook.Sheets[shoRotaSheet];
                const data = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: "" });
                
                // Extract doctor names (assuming they're in a column)
                currentDoctors = extractDoctorNames(data);
                
                console.log('Extracted doctors:', currentDoctors);
                console.log('Sheet found:', shoRotaSheet);
                
                if (currentDoctors.length === 0) {
                    showAlert('No doctor names found in the Excel file. Please check the format or try manual entry.', 'error');
                    // Show some sample data for debugging
                    console.log('Sample data from sheet:', data.slice(0, 10));
                    return;
                }

                showAlert(`‚úÖ Successfully extracted ${currentDoctors.length} doctors from "${shoRotaSheet}" sheet`, 'success');

                processAllocation();
                
            } catch (error) {
                showAlert('Error processing file: ' + error.message, 'error');
            }
        }

        function extractDoctorNames(data) {
            const doctors = [];
            let currentTeam = '';
            
            // Parse the specific Excel format we identified
            data.forEach((row, index) => {
                // Check if this row defines a team
                if (row[0] && row[0].toString().includes('Team ')) {
                    currentTeam = row[0].toString().trim();
                    
                    // If there's a doctor name in the same row (column B - index 1)
                    if (row[1] && row[1].toString().trim()) {
                        const doctorName = row[1].toString().trim();
                        if (!doctorName.includes('ADMISSIONS') && !doctorName.includes('‚Üí') && 
                            !doctorName.includes('Locum Cover')) {
                            doctors.push(doctorName);
                        }
                    }
                } 
                // Check for doctors in subsequent rows (where team column is empty but doctor name exists)
                else if ((!row[0] || row[0].toString().trim() === '') && currentTeam) {
                    if (row[1] && row[1].toString().trim()) {
                        const doctorName = row[1].toString().trim();
                        if (!doctorName.includes('ADMISSIONS') && !doctorName.includes('‚Üí') && 
                            !doctorName.includes('Locum Cover')) {
                            doctors.push(doctorName);
                        }
                    }
                }
            });
            
            // Remove duplicates and return
            return [...new Set(doctors)];
        }

        function processAllocation() {
            if (currentDoctors.length === 0) {
                showAlert('No doctors available for allocation', 'error');
                return;
            }

            // Filter out FY1 doctors
            const availableDoctors = currentDoctors.filter(doctor => 
                !doctor.toLowerCase().includes('fy1')
            );

            // Check if we have enough doctors
            const totalRequired = Object.values(TEAM_REQUIREMENTS).reduce((sum, req) => sum + req, 0);
            const needsLocum = availableDoctors.length < totalRequired;

            // Allocate doctors to teams
            const allocation = allocateDoctorsToTeams(availableDoctors);
            currentAllocation = allocation;

            // Display results
            displayResults(allocation, needsLocum, availableDoctors.length, totalRequired);
        }

        function allocateDoctorsToTeams(doctors) {
            const allocation = {
                'Team A': [],
                'Team B': [],
                'Team C': [],
                'Team D': []
            };

            const availableDoctors = [...doctors];
            const assigned = new Set();

            // First, assign preferred doctors
            Object.entries(PREFERRED_ASSIGNMENTS).forEach(([doctorName, preferredTeam]) => {
                const doctor = availableDoctors.find(d => 
                    d.toLowerCase().includes(doctorName.toLowerCase())
                );
                
                if (doctor && !assigned.has(doctor)) {
                    if (allocation[preferredTeam].length < TEAM_REQUIREMENTS[preferredTeam]) {
                        allocation[preferredTeam].push({
                            name: doctor,
                            preferred: true
                        });
                        assigned.add(doctor);
                    }
                }
            });

            // Then assign remaining doctors
            const unassignedDoctors = availableDoctors.filter(d => !assigned.has(d));
            
            Object.entries(TEAM_REQUIREMENTS).forEach(([team, requirement]) => {
                while (allocation[team].length < requirement && unassignedDoctors.length > 0) {
                    const doctor = unassignedDoctors.shift();
                    allocation[team].push({
                        name: doctor,
                        preferred: false
                    });
                    assigned.add(doctor);
                }
            });

            return allocation;
        }

        function displayResults(allocation, needsLocum, availableCount, requiredCount) {
            const resultsDiv = document.getElementById('results');
            const alertsDiv = document.getElementById('alerts');
            const statsGrid = document.getElementById('statsGrid');
            const teamGrid = document.getElementById('teamGrid');

            // Clear previous results
            alertsDiv.innerHTML = '';
            statsGrid.innerHTML = '';
            teamGrid.innerHTML = '';

            // Show alerts
            if (needsLocum) {
                const shortfall = requiredCount - availableCount;
                showAlert(`‚ö†Ô∏è LOCUM REQUIRED: You need ${shortfall} additional doctor${shortfall > 1 ? 's' : ''} to meet all team requirements`, 'warning');
            } else {
                showAlert('‚úÖ All teams can be adequately staffed with current doctors', 'success');
            }

            // Show stats
            statsGrid.innerHTML = `
                <div class="stat-card">
                    <h4>Available Doctors</h4>
                    <div class="number">${availableCount}</div>
                </div>
                <div class="stat-card">
                    <h4>Required Doctors</h4>
                    <div class="number">${requiredCount}</div>
                </div>
                <div class="stat-card">
                    <h4>Teams</h4>
                    <div class="number">${Object.keys(TEAM_REQUIREMENTS).length}</div>
                </div>
                <div class="stat-card">
                    <h4>Locums Needed</h4>
                    <div class="number">${Math.max(0, requiredCount - availableCount)}</div>
                </div>
            `;

            // Show team allocations
            Object.entries(allocation).forEach(([team, doctors]) => {
                const requirement = TEAM_REQUIREMENTS[team];
                const isUnderStaffed = doctors.length < requirement;
                
                const teamCard = document.createElement('div');
                teamCard.className = 'team-card';
                teamCard.innerHTML = `
                    <h3>${team} ${isUnderStaffed ? '‚ö†Ô∏è' : '‚úÖ'}</h3>
                    <p><strong>Required:</strong> ${requirement} | <strong>Assigned:</strong> ${doctors.length}</p>
                    <ul class="doctor-list">
                        ${doctors.map(doctor => `
                            <li class="${doctor.preferred ? 'preferred-doctor' : ''}">${doctor.name} ${doctor.preferred ? '‚≠ê' : ''}</li>
                        `).join('')}
                        ${isUnderStaffed ? '<li style="color: #e74c3c; font-style: italic;">‚ö†Ô∏è Needs locum coverage</li>' : ''}
                    </ul>
                `;
                teamGrid.appendChild(teamCard);
            });

            resultsDiv.classList.remove('hidden');
        }

        function showAlert(message, type) {
            const alertsDiv = document.getElementById('alerts');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.innerHTML = message;
            alertsDiv.appendChild(alert);
        }

        function exportToExcel() {
            if (!currentAllocation) {
                showAlert('No allocation data to export', 'error');
                return;
            }

            const ws_data = [
                ['Team', 'Doctor', 'Preferred Assignment']
            ];

            Object.entries(currentAllocation).forEach(([team, doctors]) => {
                doctors.forEach(doctor => {
                    ws_data.push([team, doctor.name, doctor.preferred ? 'Yes' : 'No']);
                });
                
                // Add empty rows for missing positions
                const requirement = TEAM_REQUIREMENTS[team];
                for (let i = doctors.length; i < requirement; i++) {
                    ws_data.push([team, 'LOCUM NEEDED', 'No']);
                }
            });

            const ws = XLSX.utils.aoa_to_sheet(ws_data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Rota Allocation');

            const filename = `Neurosurgical_Rota_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, filename);
        }

        function printRota() {
            if (!currentAllocation) {
                showAlert('No allocation data to print', 'error');
                return;
            }

            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                <head>
                    <title>Neurosurgical Rota</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        .header { text-align: center; margin-bottom: 30px; }
                        .team { margin-bottom: 20px; page-break-inside: avoid; }
                        .team h3 { background: #f0f0f0; padding: 10px; margin: 0; }
                        .team ul { list-style: none; padding: 10px; margin: 0; border: 1px solid #ddd; }
                        .team li { padding: 5px 0; }
                        .preferred { font-weight: bold; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>Neurosurgical Rota</h1>
                        <p>Week Commencing: ${new Date().toLocaleDateString()}</p>
                    </div>
                    ${Object.entries(currentAllocation).map(([team, doctors]) => `
                        <div class="team">
                            <h3>${team} (${doctors.length}/${TEAM_REQUIREMENTS[team]})</h3>
                            <ul>
                                ${doctors.map(doctor => `
                                    <li class="${doctor.preferred ? 'preferred' : ''}">${doctor.name}</li>
                                `).join('')}
                            </ul>
                        </div>
                    `).join('')}
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }
    </script>
</body>
</html>
