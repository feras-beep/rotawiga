<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Neurosurgical Rota Management System</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }
        
        .header h1 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 2.5rem;
            font-weight: 300;
        }
        
        .header p {
            color: #7f8c8d;
            font-size: 1.1rem;
        }
        
        .upload-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 25px;
            border: 2px dashed #ddd;
            text-align: center;
            transition: all 0.3s ease;
        }
        
        .upload-section:hover {
            border-color: #667eea;
            background: #f0f4ff;
        }
        
        .file-input {
            margin: 15px 0;
            padding: 12px 25px;
            border: none;
            background: #667eea;
            color: white;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
        }
        
        .file-input:hover {
            background: #5a6fd8;
            transform: translateY(-2px);
        }
        
        .button {
            padding: 12px 25px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
            margin: 10px;
        }
        
        .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }
        
        .button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .results-section {
            margin-top: 25px;
        }
        
        .team-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .team-card {
            background: linear-gradient(135deg, #ffffff, #f8f9fa);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }
        
        .team-card:hover {
            transform: translateY(-5px);
        }
        
        .team-card h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.3rem;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 10px;
        }
        
        .doctor-list {
            list-style: none;
        }
        
        .doctor-list li {
            padding: 8px 12px;
            margin: 5px 0;
            background: #e8f4f8;
            border-radius: 8px;
            color: #2c3e50;
            font-weight: 500;
        }
        
        .preferred-doctor {
            background: #d4edda !important;
            border-left: 4px solid #28a745;
        }
        
        .alert {
            padding: 15px 20px;
            border-radius: 10px;
            margin: 15px 0;
            font-weight: 500;
        }
        
        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }
        
        .stat-card h4 {
            font-size: 0.9rem;
            opacity: 0.9;
            margin-bottom: 5px;
        }
        
        .stat-card .number {
            font-size: 2rem;
            font-weight: bold;
        }
        
        .export-section {
            margin-top: 25px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 15px;
            text-align: center;
        }
        
        .hidden {
            display: none;
        }
        
        .manual-input {
            background: #ffffff;
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
            border: 1px solid #e0e0e0;
        }
        
        .input-group {
            margin: 15px 0;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 5px;
            color: #2c3e50;
            font-weight: 500;
        }
        
        .input-group input, .input-group textarea {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
        }
        
        .input-group textarea {
            height: 100px;
            resize: vertical;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè• Neurosurgical Rota Manager</h1>
            <p>Automated weekly consultant team allocation system</p>
        </div>
        
        <div class="upload-section">
            <h3>üìÅ Upload Excel File</h3>
            <p>Select your weekly rota Excel file (will automatically find 'SHO Rota' sheet)</p>
            <input type="file" id="fileInput" accept=".xlsx,.xls" class="file-input">
            <div id="fileInfo" class="hidden"></div>
        </div>
        
        <div class="manual-input" id="manualInput">
            <h3>‚úèÔ∏è Manual Doctor Entry</h3>
            <p>If you don't have an Excel file, you can manually enter the available doctors:</p>
            <div class="input-group">
                <label for="doctorList">Available Doctors (one per line):</label>
                <textarea id="doctorList" placeholder="Munashe Veremu&#10;Hassan Bin Ajmal&#10;Michael Bandrivskyi&#10;George Hudson&#10;Sanchita Bhatia&#10;Suraj Sennik&#10;Danyal Khan FY1&#10;Feras Fayez"></textarea>
            </div>
            <button class="button" onclick="processManualInput()">Process Manual Input</button>
        </div>
        
        <div class="button-group" style="text-align: center;">
            <button class="button" id="processBtn" onclick="processRota()" disabled>üîÑ Process Rota</button>
            <button class="button" onclick="generateSampleData()">üìù Use Sample Data</button>
        </div>
        
        <div id="results" class="results-section hidden">
            <div id="alerts"></div>
            
            <div class="stats-grid" id="statsGrid"></div>
            
            <div class="team-grid" id="teamGrid"></div>
            
            <div class="export-section">
                <button class="button" onclick="exportToExcel()">üìä Export to Excel</button>
                <button class="button" onclick="printRota()">üñ®Ô∏è Print Rota</button>
                <button class="button" onclick="copyAllMessages()">üìã Copy All Weekday Messages (Mon-Fri)</button>
            </div>
        </div>
    </div>

    <script>
        let currentDoctors = [];
        let currentAllocation = null;
        let weekStartDate = new Date('2025-08-18');
        let currentDayIndex = 0;

        // Team requirements - clean version
        const TEAM_REQUIREMENTS = {
            'Pituitary + Epilepsy': 1,
            'Functional': 1,
            'Hydrocephalus': 1,
            'PG/WM': 1,
            'PC/MM': 1,
            'Team C': 1,
            'Team D': 1
        };

        // Consultant teams info
        const CONSULTANT_TEAMS = {
            'Pituitary + Epilepsy': {
                consultants: ['ND', 'HM', 'RB', 'AB', 'AWM', 'ANM'],
                requiredDoctors: 1
            },
            'Functional': {
                consultants: ['JH', 'HA', 'LZ', 'MK'],
                requiredDoctors: 1
            },
            'Hydrocephalus': {
                consultants: ['AT', 'LW'],
                requiredDoctors: 1
            },
            'PG/WM': {
                consultants: ['PG', 'WM'],
                requiredDoctors: 1
            },
            'PC/MM': {
                consultants: ['PC', 'MM'],
                requiredDoctors: 1
            },
            'Team C': {
                consultants: ['CH', 'LT', 'NK', 'RM'],
                requiredDoctors: 1
            },
            'Team D': {
                consultants: ['PS', 'JA', 'NZ', 'DC', 'VR', 'AR', 'ATC', 'GP', 'IH'],
                requiredDoctors: 1
            }
        };

        // Special duties
        const SPECIAL_DUTIES = {
            'Clerking Shift': 2,
            'On-call bleep': 1,
            'Second on-call': 1,
            'Night on-call': 1
        };

        // Preferred assignments
        const PREFERRED_ASSIGNMENTS = {
            'suraj': 'PC/MM',
            'sanchita': 'Night on-call',
            'george': 'Functional',
            'michael': 'Pituitary + Epilepsy',
            'sabrina': 'PG/WM',
            'oleksii': 'Hydrocephalus',
            'constantinos': 'Team C',
            'mohammed': 'Team D',
            'redwan': 'Team D',
            'feras': 'Team D',
            'danyal': 'Team C'
        };

        document.getElementById('fileInput').addEventListener('change', handleFileSelect);

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                const fileInfo = document.getElementById('fileInfo');
                fileInfo.innerHTML = `<p>Selected: ${file.name}</p>`;
                fileInfo.classList.remove('hidden');
                document.getElementById('processBtn').disabled = false;
            }
        }

        function generateSampleData() {
            const sampleDoctors = [
                'Munashe Veremu', 'Hassan Bin Ajmal', 'Michael Bandrivskyi', 'Taha Albohassan', 
                'George Hudson', 'Sanchita Bhatia', 'Redwan Jabbar', 'Suraj Sennik', 
                'Hamza Salhab', 'Sandie Eiras', 'Oleksii Goncharuk', 'Shamimur Rahman',
                'Constantinos Thoma', 'Danyal Khan FY1', 'Sabrina Smith', 'Ioannis Koukoulithras',
                'Mohammed Lester', 'Feras Fayez'
            ];
            currentDoctors = sampleDoctors;
            document.getElementById('doctorList').value = sampleDoctors.join('\n');
            processAllocation();
        }

        function processManualInput() {
            const doctorText = document.getElementById('doctorList').value.trim();
            if (!doctorText) {
                showAlert('Please enter at least one doctor name', 'error');
                return;
            }
            
            currentDoctors = doctorText.split('\n')
                .map(name => name.trim())
                .filter(name => name.length > 0);
            
            processAllocation();
        }

        async function processRota() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            
            if (!file) {
                showAlert('Please select an Excel file first', 'error');
                return;
            }

            try {
                console.log('Processing file:', file.name);
                
                const arrayBuffer = await file.arrayBuffer();
                const workbook = XLSX.read(arrayBuffer);
                
                console.log('Available sheets:', workbook.SheetNames);
                
                let shoRotaSheet = workbook.SheetNames.find(name => 
                    name.toLowerCase() === 'sho rota'
                );
                
                if (!shoRotaSheet) {
                    shoRotaSheet = workbook.SheetNames.find(name => 
                        name.toLowerCase().includes('sho')
                    );
                }

                if (!shoRotaSheet) {
                    showAlert('Could not find "SHO Rota" sheet. Available sheets: ' + workbook.SheetNames.join(', '), 'error');
                    return;
                }

                console.log('Using sheet:', shoRotaSheet);
                
                const worksheet = workbook.Sheets[shoRotaSheet];
                const data = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: "" });
                
                console.log('Data rows:', data.length);
                
                currentDoctors = extractDoctorNames(data);
                
                console.log('Extracted doctors:', currentDoctors);
                console.log('Doctor count:', currentDoctors.length);
                
                if (currentDoctors.length === 0) {
                    showAlert('No doctor names found in the Excel file. Please check the format or try manual entry.', 'error');
                    return;
                }

                showAlert(`‚úÖ Successfully extracted ${currentDoctors.length} doctors from "${shoRotaSheet}" sheet`, 'success');
                
                console.log('About to call processAllocation...');
                processAllocation();
                
            } catch (error) {
                console.error('Error in processRota:', error);
                showAlert('Error processing file: ' + error.message, 'error');
            }
        }

        function extractDoctorNames(data) {
            const doctors = [];
            let currentTeam = '';
            
            // Extract week starting date
            const weekCommencingRow = data.find(row => 
                row[0] && row[0].toString().toLowerCase().includes('w/c')
            );
            
            if (weekCommencingRow) {
                const dateMatch = weekCommencingRow[0].match(/(\d{1,2}(?:st|nd|rd|th)?\s+\w+\s+\d{4})/i);
                if (dateMatch) {
                    try {
                        const dateStr = dateMatch[1].replace(/(\d+)(st|nd|rd|th)/, '$1');
                        const parsedDate = new Date(dateStr);
                        if (!isNaN(parsedDate.getTime())) {
                            weekStartDate = parsedDate;
                        }
                    } catch (e) {
                        // Use default date
                    }
                }
            }
            
            // Extract doctors from Excel data
            data.forEach((row, index) => {
                // Check for team headers (including "TEAM D")
                if (row[0] && (row[0].toString().includes('Team ') || row[0].toString().includes('TEAM'))) {
                    currentTeam = row[0].toString().trim();
                    
                    // Doctor in same row as team header
                    if (row[1] && row[1].toString().trim()) {
                        const doctorName = row[1].toString().trim();
                        if (!doctorName.includes('ADMISSIONS') && !doctorName.includes('‚Üí') && 
                            !doctorName.includes('Locum Cover') && doctorName !== 'PP') {
                            doctors.push({
                                name: doctorName,
                                team: currentTeam,
                                firm: row[2] || '',
                                shifts: {
                                    monday: row[4] || '',
                                    tuesday: row[5] || '',
                                    wednesday: row[6] || '',
                                    thursday: row[7] || '',
                                    friday: row[8] || ''
                                }
                            });
                        }
                    }
                } 
                // Doctors in subsequent rows
                else if ((!row[0] || row[0].toString().trim() === '') && currentTeam) {
                    if (row[1] && row[1].toString().trim()) {
                        const doctorName = row[1].toString().trim();
                        if (!doctorName.includes('ADMISSIONS') && !doctorName.includes('‚Üí') && 
                            !doctorName.includes('Locum Cover') && doctorName !== 'PP') {
                            doctors.push({
                                name: doctorName,
                                team: currentTeam,
                                firm: row[2] || '',
                                shifts: {
                                    monday: row[4] || '',
                                    tuesday: row[5] || '',
                                    wednesday: row[6] || '',
                                    thursday: row[7] || '',
                                    friday: row[8] || ''
                                }
                            });
                        }
                    }
                }
            });
            
            // Store for later use
            window.doctorShiftData = doctors;
            return [...new Set(doctors.map(d => d.name))];
        }

        function processAllocation() {
            console.log('processAllocation called with doctors:', currentDoctors);
            
            if (currentDoctors.length === 0) {
                showAlert('No doctors available for allocation', 'error');
                return;
            }

            // Filter out FY1 doctors from main count
            const availableDoctors = currentDoctors.filter(doctor => 
                !doctor.toLowerCase().includes('fy1')
            );

            console.log('Available doctors (non-FY1):', availableDoctors);

            // Check if we have enough doctors (need 7 total excluding FY1)
            const totalRequired = 7;
            const needsLocum = availableDoctors.length < totalRequired;

            console.log('Need locum?', needsLocum, 'Available:', availableDoctors.length, 'Required:', totalRequired);

            // Allocate doctors to teams
            console.log('Calling allocateDoctorsToTeams...');
            const result = allocateDoctorsToTeams(availableDoctors);
            console.log('Allocation result:', result);
            
            currentAllocation = result;

            // Display results
            console.log('Calling displayResults...');
            displayResults(result.allocation, result.specialDuties, needsLocum, availableDoctors.length, totalRequired);
        }

        function allocateDoctorsToTeams(doctors) {
            const allocation = {};
            const specialDuties = {};
            
            // Initialize teams
            Object.keys(CONSULTANT_TEAMS).forEach(team => {
                allocation[team] = [];
            });
            
            Object.keys(SPECIAL_DUTIES).forEach(duty => {
                specialDuties[duty] = [];
            });

            const availableDoctors = [...doctors];
            const assigned = new Set();

            // Add FY1 doctors to Team C
            const fy1Doctors = currentDoctors.filter(d => d.name ? d.name.toLowerCase().includes('fy1') : d.toLowerCase().includes('fy1'));
            fy1Doctors.forEach(doctor => {
                allocation['Team C'].push({
                    name: typeof doctor === 'string' ? doctor : doctor.name,
                    preferred: false
                });
            });

            // Assign preferred doctors
            Object.entries(PREFERRED_ASSIGNMENTS).forEach(([doctorKey, preferredRole]) => {
                const doctor = availableDoctors.find(d => 
                    d.toLowerCase().includes(doctorKey.toLowerCase())
                );
                
                if (doctor && !assigned.has(doctor)) {
                    if (SPECIAL_DUTIES[preferredRole] && specialDuties[preferredRole].length < SPECIAL_DUTIES[preferredRole]) {
                        specialDuties[preferredRole].push({
                            name: doctor,
                            preferred: true
                        });
                        assigned.add(doctor);
                    }
                    else if (CONSULTANT_TEAMS[preferredRole] && allocation[preferredRole].length < TEAM_REQUIREMENTS[preferredRole]) {
                        allocation[preferredRole].push({
                            name: doctor,
                            preferred: true
                        });
                        assigned.add(doctor);
                    }
                }
            });

            // Fill remaining spots
            const unassignedDoctors = availableDoctors.filter(d => !assigned.has(d));
            
            Object.entries(TEAM_REQUIREMENTS).forEach(([team, requirement]) => {
                while (allocation[team].length < requirement && unassignedDoctors.length > 0) {
                    const doctor = unassignedDoctors.shift();
                    allocation[team].push({
                        name: doctor,
                        preferred: false
                    });
                    assigned.add(doctor);
                }
            });

            Object.entries(SPECIAL_DUTIES).forEach(([duty, requirement]) => {
                while (specialDuties[duty].length < requirement && unassignedDoctors.length > 0) {
                    const doctor = unassignedDoctors.shift();
                    specialDuties[duty].push({
                        name: doctor,
                        preferred: false
                    });
                    assigned.add(doctor);
                }
            });

            return { allocation, specialDuties };
        }

        function displayResults(allocation, specialDuties, needsLocum, availableCount, requiredCount) {
            console.log('displayResults called with:', { allocation, specialDuties, needsLocum, availableCount, requiredCount });
            
            const resultsDiv = document.getElementById('results');
            const alertsDiv = document.getElementById('alerts');
            const statsGrid = document.getElementById('statsGrid');
            const teamGrid = document.getElementById('teamGrid');

            if (!resultsDiv || !alertsDiv || !statsGrid || !teamGrid) {
                console.error('Required DOM elements not found');
                return;
            }

            alertsDiv.innerHTML = '';
            statsGrid.innerHTML = '';
            teamGrid.innerHTML = '';

            if (needsLocum) {
                const shortfall = requiredCount - availableCount;
                showAlert(`‚ö†Ô∏è LOCUM REQUIRED: You need ${shortfall} additional doctor${shortfall > 1 ? 's' : ''} to meet all team requirements`, 'warning');
            } else {
                showAlert('‚úÖ All teams can be adequately staffed with current doctors', 'success');
            }

            console.log('Adding stats...');
            statsGrid.innerHTML = `
                <div class="stat-card">
                    <h4>Available Doctors</h4>
                    <div class="number">${availableCount}</div>
                </div>
                <div class="stat-card">
                    <h4>Required Doctors</h4>
                    <div class="number">${requiredCount}</div>
                </div>
                <div class="stat-card">
                    <h4>Consultant Teams</h4>
                    <div class="number">${Object.keys(CONSULTANT_TEAMS).length}</div>
                </div>
                <div class="stat-card">
                    <h4>Special Duties</h4>
                    <div class="number">${Object.keys(SPECIAL_DUTIES).length}</div>
                </div>
            `;

            console.log('Adding team cards...');
            // Show team allocations
            Object.entries(allocation).forEach(([team, doctors]) => {
                const requirement = TEAM_REQUIREMENTS[team];
                const consultantInfo = CONSULTANT_TEAMS[team];
                
                console.log(`Creating card for ${team} with ${doctors.length} doctors`);
                
                const teamCard = document.createElement('div');
                teamCard.className = 'team-card';
                teamCard.innerHTML = `
                    <h3>${team} ‚úÖ</h3>
                    <p><strong>Consultants:</strong> ${consultantInfo.consultants.join(', ')}</p>
                    <p><strong>Required:</strong> ${requirement} | <strong>Assigned:</strong> ${doctors.length}</p>
                    <ul class="doctor-list">
                        ${doctors.map(doctor => `
                            <li class="${doctor.preferred ? 'preferred-doctor' : ''}">${doctor.name}</li>
                        `).join('')}
                    </ul>
                `;
                teamGrid.appendChild(teamCard);
            });

            console.log('Adding special duty cards...');
            // Show special duties
            Object.entries(specialDuties).forEach(([duty, doctors]) => {
                const requirement = SPECIAL_DUTIES[duty];
                
                const dutyCard = document.createElement('div');
                dutyCard.className = 'team-card';
                dutyCard.style.background = 'linear-gradient(135deg, #ffeaa7, #fab1a0)';
                dutyCard.innerHTML = `
                    <h3>üîî ${duty} ‚úÖ</h3>
                    <p><strong>Required:</strong> ${requirement} | <strong>Assigned:</strong> ${doctors.length}</p>
                    <ul class="doctor-list">
                        ${doctors.map(doctor => `
                            <li class="${doctor.preferred ? 'preferred-doctor' : ''}">${doctor.name}</li>
                        `).join('')}
                    </ul>
                `;
                teamGrid.appendChild(dutyCard);
            });

            console.log('Adding day navigator...');
            // Add day navigator
            const dayNavCard = document.createElement('div');
            dayNavCard.className = 'team-card';
            dayNavCard.style.background = 'linear-gradient(135deg, #6c5ce7, #a29bfe)';
            dayNavCard.style.color = 'white';
            dayNavCard.innerHTML = `
                <h3>üìÖ Weekday Rota Navigator (Mon-Fri)</h3>
                <div style="display: flex; justify-content: space-between; align-items: center; margin: 20px 0;">
                    <button class="button" onclick="previousDay()" style="background: rgba(255,255,255,0.2); color: white;">‚óÄ Previous</button>
                    <div id="currentDayDisplay" style="text-align: center; font-size: 1.2rem; font-weight: bold;"></div>
                    <button class="button" onclick="nextDay()" style="background: rgba(255,255,255,0.2); color: white;">Next ‚ñ∂</button>
                </div>
                <div style="display: flex; justify-content: center; gap: 10px; margin: 15px 0; flex-wrap: wrap;">
                    <button class="button" onclick="goToDay(0)" style="background: rgba(255,255,255,0.2); color: white; font-size: 0.9rem;">Mon</button>
                    <button class="button" onclick="goToDay(1)" style="background: rgba(255,255,255,0.2); color: white; font-size: 0.9rem;">Tue</button>
                    <button class="button" onclick="goToDay(2)" style="background: rgba(255,255,255,0.2); color: white; font-size: 0.9rem;">Wed</button>
                    <button class="button" onclick="goToDay(3)" style="background: rgba(255,255,255,0.2); color: white; font-size: 0.9rem;">Thu</button>
                    <button class="button" onclick="goToDay(4)" style="background: rgba(255,255,255,0.2); color: white; font-size: 0.9rem;">Fri</button>
                </div>
                <div id="currentDayAllocation" style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px; font-family: monospace; white-space: pre-line; font-size: 0.9rem;"></div>
                <button class="button" onclick="copyCurrentDay()" style="background: white; color: #6c5ce7; margin-top: 10px;">üìã Copy Today's Message</button>
            `;
            teamGrid.appendChild(dayNavCard);

            console.log('Calling updateCurrentDayDisplay...');
            updateCurrentDayDisplay();
            
            console.log('Showing results div...');
            resultsDiv.classList.remove('hidden');
            
            console.log('displayResults completed');
        }

        function updateCurrentDayDisplay() {
            const currentDate = new Date(weekStartDate);
            currentDate.setDate(weekStartDate.getDate() + currentDayIndex);
            
            const dayNames = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'];
            const dayName = dayNames[currentDayIndex % 5];
            const dayKey = dayName.toLowerCase();
            const formattedDate = currentDate.toLocaleDateString('en-GB', { 
                day: '2-digit', 
                month: '2-digit', 
                year: '2-digit' 
            });

            const displayDiv = document.getElementById('currentDayDisplay');
            if (displayDiv) {
                displayDiv.innerHTML = `${dayName}<br>${formattedDate}`;
            }

            const allocationDiv = document.getElementById('currentDayAllocation');
            if (allocationDiv && currentAllocation) {
                const message = generateDailyMessageText(formattedDate, dayName);
                allocationDiv.textContent = message;
            }

            // Update stats to show daily availability
            updateDailyStats(dayKey);

            // Update day button highlighting
            const dayButtons = document.querySelectorAll('[onclick^="goToDay"]');
            dayButtons.forEach((button, index) => {
                if (index === currentDayIndex) {
                    button.style.background = 'rgba(255,255,255,0.4)';
                    button.style.fontWeight = 'bold';
                } else {
                    button.style.background = 'rgba(255,255,255,0.2)';
                    button.style.fontWeight = 'normal';
                }
            });
        }

        function updateDailyStats(dayKey) {
            if (!window.doctorShiftData) return;

            const statsGrid = document.getElementById('statsGrid');
            if (!statsGrid) return;

            // Get daily availability for each day
            const dailyAvailability = {};
            const dayNames = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'];
            
            dayNames.forEach(day => {
                const dayKeyLocal = day.toLowerCase();
                const availableToday = window.doctorShiftData.filter(doctor => {
                    const shift = doctor.shifts[dayKeyLocal] || '';
                    const upperShift = shift.toUpperCase();
                    return shift && 
                           !upperShift.includes('AL') && 
                           !upperShift.includes('ZERO') && 
                           !upperShift.includes('SL') && 
                           !upperShift.includes('WEISS') &&
                           !upperShift.startsWith('NIGHT') &&
                           shift.trim() !== '' &&
                           !doctor.name.toLowerCase().includes('fy1'); // Exclude FY1 from count
                });
                dailyAvailability[day] = availableToday.length;
            });

            // Highlight current day
            const currentDay = dayNames[currentDayIndex % 5];
            
            statsGrid.innerHTML = `
                <div class="stat-card" style="background: ${currentDay === 'Monday' ? 'linear-gradient(135deg, #74b9ff, #0984e3)' : 'linear-gradient(135deg, #667eea, #764ba2)'}">
                    <h4>Monday Available</h4>
                    <div class="number">${dailyAvailability['Monday'] || 0}</div>
                </div>
                <div class="stat-card" style="background: ${currentDay === 'Tuesday' ? 'linear-gradient(135deg, #74b9ff, #0984e3)' : 'linear-gradient(135deg, #667eea, #764ba2)'}">
                    <h4>Tuesday Available</h4>
                    <div class="number">${dailyAvailability['Tuesday'] || 0}</div>
                </div>
                <div class="stat-card" style="background: ${currentDay === 'Wednesday' ? 'linear-gradient(135deg, #74b9ff, #0984e3)' : 'linear-gradient(135deg, #667eea, #764ba2)'}">
                    <h4>Wednesday Available</h4>
                    <div class="number">${dailyAvailability['Wednesday'] || 0}</div>
                </div>
                <div class="stat-card" style="background: ${currentDay === 'Thursday' ? 'linear-gradient(135deg, #74b9ff, #0984e3)' : 'linear-gradient(135deg, #667eea, #764ba2)'}">
                    <h4>Thursday Available</h4>
                    <div class="number">${dailyAvailability['Thursday'] || 0}</div>
                </div>
                <div class="stat-card" style="background: ${currentDay === 'Friday' ? 'linear-gradient(135deg, #74b9ff, #0984e3)' : 'linear-gradient(135deg, #667eea, #764ba2)'}">
                    <h4>Friday Available</h4>
                    <div class="number">${dailyAvailability['Friday'] || 0}</div>
                </div>
            `;
        }

        function previousDay() {
            currentDayIndex = (currentDayIndex - 1 + 5) % 5;
            updateCurrentDayDisplay();
        }

        function nextDay() {
            currentDayIndex = (currentDayIndex + 1) % 5;
            updateCurrentDayDisplay();
        }

        function goToDay(dayIndex) {
            currentDayIndex = dayIndex;
            updateCurrentDayDisplay();
        }

        function copyCurrentDay() {
            const allocationDiv = document.getElementById('currentDayAllocation');
            if (allocationDiv && allocationDiv.textContent) {
                navigator.clipboard.writeText(allocationDiv.textContent).then(() => {
                    showAlert('‚úÖ Current day message copied to clipboard!', 'success');
                });
            } else {
                showAlert('No allocation data to copy', 'error');
            }
        }

        function generateDailyMessageText(formattedDate, dayName) {
            if (!window.doctorShiftData) {
                // Fallback to basic allocation if no shift data
                return generateBasicMessage(formattedDate, dayName);
            }

            const dayNames = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'];
            const dayKey = dayName.toLowerCase();
            
            let message = `SHO Team allocations for ${formattedDate} ${dayName}\n\n`;

            // Get doctors working this day based on actual Excel shifts
            const availableToday = window.doctorShiftData.filter(doctor => {
                const shift = doctor.shifts[dayKey] || '';
                const upperShift = shift.toUpperCase();
                return shift && 
                       !upperShift.includes('AL') && 
                       !upperShift.includes('ZERO') && 
                       !upperShift.includes('SL') && 
                       !upperShift.includes('WEISS') &&
                       !upperShift.startsWith('NIGHT') &&
                       shift.trim() !== '';
            });

            // Get special duty assignments for this day
            const clerkingShifts = window.doctorShiftData.filter(doctor => {
                const shift = doctor.shifts[dayKey] || '';
                return shift.startsWith('0700-') || shift.startsWith('07');
            });

            const ldBleeps = window.doctorShiftData.filter(doctor => {
                const shift = doctor.shifts[dayKey] || '';
                return shift.toUpperCase().includes('LD BLEEP');
            });

            const ldSeconds = window.doctorShiftData.filter(doctor => {
                const shift = doctor.shifts[dayKey] || '';
                return shift.toUpperCase().includes('LD SECOND');
            });

            const nightShifts = window.doctorShiftData.filter(doctor => {
                const shift = doctor.shifts[dayKey] || '';
                return shift.toUpperCase().includes('NIGHT');
            });

            // Organize by consultant teams with priority assignments
            const teamAllocations = organizeTeamsForDay(availableToday);

            let counter = 1;

            // Generate team assignments
            Object.entries(teamAllocations).forEach(([teamName, doctors]) => {
                if (doctors.length > 0) {
                    if (teamName === 'Functional') {
                        message += `${counter}. Functional:\n`;
                        const firstName = doctors[0].split(' ')[0];
                        message += `      ${firstName}(JH & HA)\n`;
                    } else if (teamName === 'Team C') {
                        message += `${counter}. Team C:\n`;
                        doctors.forEach((doctor, index) => {
                            const firstName = doctor.split(' ')[0];
                            let consultantInfo = '';
                            if (index === 0) consultantInfo = ' (CH)';
                            else if (index === 1) consultantInfo = '(LT & NK)';
                            else if (doctor.toLowerCase().includes('fy1')) consultantInfo = ' (RM)';
                            
                            message += `   ${firstName}${consultantInfo}\n`;
                        });
                    } else if (teamName === 'Team D') {
                        const doctorNames = doctors.map(d => d.split(' ')[0]).join(' & ');
                        message += `${counter}. Team D - ${doctorNames}\n`;
                    } else {
                        const firstName = doctors[0].split(' ')[0];
                        const consultantCodes = {
                            'Pituitary + Epilepsy': '(ND/HM/RB/AB & AWM/ANM)',
                            'Hydrocephalus': '(AT/LW)',
                            'PG/WM': '',
                            'PC/MM': ''
                        };
                        message += `${counter}. ${teamName} ${consultantCodes[teamName] || ''} - ${firstName}\n`;
                    }
                    counter++;
                }
            });

            // Add special duties
            message += '\n';
            
            if (clerkingShifts.length > 0) {
                const doctors = clerkingShifts.map(d => d.name.split(' ')[0].toLowerCase()).join(', ');
                message += `Clerking Shift: ${doctors}\n`;
            }

            if (ldBleeps.length > 0) {
                const doctor = ldBleeps[0].name.split(' ')[0].toLowerCase();
                message += `On-call bleep: ${doctor}\n`;
            }

            if (ldSeconds.length > 0) {
                const doctor = ldSeconds[0].name.split(' ')[0].toLowerCase();
                message += `Second on-call: ${doctor}\n`;
            }

            if (nightShifts.length > 0) {
                const doctor = nightShifts[0].name.split(' ')[0];
                message += `Night on-call: ${doctor}`;
            }

            return message;
        }

        function organizeTeamsForDay(availableToday) {
            // Always assign Suraj to PC/MM if available
            const surajDoctor = availableToday.find(d => d.name.toLowerCase().includes('suraj'));
            
            // Always assign Feras to Team D if available
            const ferasDoctor = availableToday.find(d => d.name.toLowerCase().includes('feras'));
            
            // FY1 doctors always go to Team C
            const fy1Doctors = availableToday.filter(d => d.name.toLowerCase().includes('fy1'));
            
            const teamAllocations = {
                'Pituitary + Epilepsy': [],
                'Functional': [],
                'Hydrocephalus': [],
                'PG/WM': [],
                'PC/MM': surajDoctor ? [surajDoctor.name] : [],
                'Team C': fy1Doctors.map(d => d.name),
                'Team D': ferasDoctor ? [ferasDoctor.name] : []
            };

            // Remove already assigned doctors
            const assignedNames = [
                ...(surajDoctor ? [surajDoctor.name] : []),
                ...(ferasDoctor ? [ferasDoctor.name] : []),
                ...fy1Doctors.map(d => d.name)
            ];
            
            const remainingDoctors = availableToday.filter(d => !assignedNames.includes(d.name));

            // Assign remaining doctors based on firm codes
            remainingDoctors.forEach(doctor => {
                const firm = doctor.firm.toUpperCase();
                
                if (['ND', 'HM', 'RB', 'AB', 'AWM', 'ANM'].some(code => firm.includes(code))) {
                    teamAllocations['Pituitary + Epilepsy'].push(doctor.name);
                } else if (['LZ', 'JH', 'HA', 'MK'].some(code => firm.includes(code))) {
                    teamAllocations['Functional'].push(doctor.name);
                } else if (['AT', 'LW'].some(code => firm.includes(code))) {
                    teamAllocations['Hydrocephalus'].push(doctor.name);
                } else if (['PG', 'WM'].some(code => firm.includes(code))) {
                    teamAllocations['PG/WM'].push(doctor.name);
                } else if (['PC', 'MM'].some(code => firm.includes(code)) && !surajDoctor) {
                    teamAllocations['PC/MM'].push(doctor.name);
                } else if (['HS', 'NK', 'RO', 'RM', 'CH', 'LT'].some(code => firm.includes(code))) {
                    teamAllocations['Team C'].push(doctor.name);
                } else if (['PS', 'JA', 'NZ', 'DC', 'VR', 'AR', 'ATC', 'GP', 'IH'].some(code => firm.includes(code))) {
                    teamAllocations['Team D'].push(doctor.name);
                } else {
                    // Unassigned doctors go to Team C
                    teamAllocations['Team C'].push(doctor.name);
                }
            });

            // Ensure every team has at least one person if possible
            Object.entries(teamAllocations).forEach(([team, doctors]) => {
                if (doctors.length === 0 && remainingDoctors.length > 0) {
                    // Find a team with multiple people to borrow from
                    const donorTeam = Object.entries(teamAllocations).find(([name, docs]) => 
                        docs.length > 1 && ['Team C', 'Team D'].includes(name)
                    );
                    if (donorTeam) {
                        teamAllocations[team].push(donorTeam[1].pop());
                    }
                }
            });

            return teamAllocations;
        }

        function generateBasicMessage(formattedDate, dayName) {
            if (!currentAllocation) return '';

            const allocation = currentAllocation.allocation;
            const specialDuties = currentAllocation.specialDuties;

            let message = `SHO Team allocations for ${formattedDate} ${dayName}\n\n`;
            let counter = 1;

            // Generate team assignments
            Object.entries(allocation).forEach(([teamName, doctors]) => {
                if (doctors.length > 0) {
                    if (teamName === 'Functional') {
                        message += `${counter}. Functional:\n`;
                        const firstName = doctors[0].name.split(' ')[0];
                        message += `      ${firstName}(JH & HA)\n`;
                    } else if (teamName === 'Team C') {
                        message += `${counter}. Team C:\n`;
                        doctors.forEach((doctor, index) => {
                            const firstName = doctor.name.split(' ')[0];
                            let consultantInfo = '';
                            if (index === 0) consultantInfo = ' (CH)';
                            else if (index === 1) consultantInfo = '(LT & NK)';
                            else if (doctor.name.toLowerCase().includes('fy1')) consultantInfo = ' (RM)';
                            
                            message += `   ${firstName}${consultantInfo}\n`;
                        });
                    } else if (teamName === 'Team D') {
                        const doctorNames = doctors.map(d => d.name.split(' ')[0]).join(' & ');
                        message += `${counter}. Team D - ${doctorNames}\n`;
                    } else {
                        const firstName = doctors[0].name.split(' ')[0];
                        const consultantCodes = {
                            'Pituitary + Epilepsy': '(ND/HM/RB/AB & AWM/ANM)',
                            'Hydrocephalus': '(AT/LW)',
                            'PG/WM': '',
                            'PC/MM': ''
                        };
                        message += `${counter}. ${teamName} ${consultantCodes[teamName] || ''} - ${firstName}\n`;
                    }
                    counter++;
                }
            });

            // Add special duties
            message += '\n';
            
            if (specialDuties['Clerking Shift'] && specialDuties['Clerking Shift'].length > 0) {
                const doctors = specialDuties['Clerking Shift'].map(d => d.name.split(' ')[0].toLowerCase()).join(', ');
                message += `Clerking Shift: ${doctors}\n`;
            }

            if (specialDuties['On-call bleep'] && specialDuties['On-call bleep'].length > 0) {
                const doctor = specialDuties['On-call bleep'][0].name.split(' ')[0].toLowerCase();
                message += `On-call bleep: ${doctor}\n`;
            }

            if (specialDuties['Second on-call'] && specialDuties['Second on-call'].length > 0) {
                const doctor = specialDuties['Second on-call'][0].name.split(' ')[0].toLowerCase();
                message += `Second on-call: ${doctor}\n`;
            }

            if (specialDuties['Night on-call'] && specialDuties['Night on-call'].length > 0) {
                const doctor = specialDuties['Night on-call'][0].name.split(' ')[0];
                message += `Night on-call: ${doctor}`;
            }

            return message;
        }

        function showAlert(message, type) {
            const alertsDiv = document.getElementById('alerts');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.innerHTML = message;
            alertsDiv.appendChild(alert);
        }

        function copyAllMessages() {
            if (!currentAllocation) {
                showAlert('No allocation data available. Please process a rota first.', 'error');
                return;
            }

            let allMessages = '';
            const daysOfWeek = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'];

            for (let i = 0; i < 5; i++) {
                const currentDate = new Date(weekStartDate);
                currentDate.setDate(weekStartDate.getDate() + i);
                
                const dayName = daysOfWeek[i];
                const formattedDate = currentDate.toLocaleDateString('en-GB', { 
                    day: '2-digit', 
                    month: '2-digit', 
                    year: '2-digit' 
                });

                allMessages += generateDailyMessageText(formattedDate, dayName);
                if (i < 4) allMessages += '\n' + '='.repeat(50) + '\n\n';
            }

            navigator.clipboard.writeText(allMessages).then(() => {
                showAlert('‚úÖ All weekday messages (Mon-Fri) copied to clipboard!', 'success');
            });
        }

        function exportToExcel() {
            if (!currentAllocation) {
                showAlert('No allocation data to export', 'error');
                return;
            }

            const ws_data = [
                ['Assignment Type', 'Team/Duty', 'Doctor', 'Consultants', 'Preferred Assignment']
            ];

            Object.entries(currentAllocation.allocation).forEach(([team, doctors]) => {
                const consultants = CONSULTANT_TEAMS[team]?.consultants.join(', ') || '';
                doctors.forEach(doctor => {
                    ws_data.push(['Consultant Team', team, doctor.name, consultants, doctor.preferred ? 'Yes' : 'No']);
                });
            });

            Object.entries(currentAllocation.specialDuties).forEach(([duty, doctors]) => {
                doctors.forEach(doctor => {
                    ws_data.push(['Special Duty', duty, doctor.name, '', doctor.preferred ? 'Yes' : 'No']);
                });
            });

            const ws = XLSX.utils.aoa_to_sheet(ws_data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Consultant Rota Allocation');

            const filename = `Neurosurgical_Consultant_Rota_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, filename);
        }

        function printRota() {
            if (!currentAllocation) {
                showAlert('No allocation data to print', 'error');
                return;
            }

            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                <head>
                    <title>Neurosurgical Consultant Rota</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        .header { text-align: center; margin-bottom: 30px; }
                        .team { margin-bottom: 20px; page-break-inside: avoid; }
                        .team h3 { background: #f0f0f0; padding: 10px; margin: 0; }
                        .team ul { list-style: none; padding: 10px; margin: 0; border: 1px solid #ddd; }
                        .team li { padding: 5px 0; }
                        .preferred { font-weight: bold; }
                        .special-duty { background: #fff3cd; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>Neurosurgical Consultant Rota</h1>
                        <p>Week Commencing: ${weekStartDate.toLocaleDateString()}</p>
                    </div>
                    
                    <h2>Consultant Teams</h2>
                    ${Object.entries(currentAllocation.allocation).map(([team, doctors]) => `
                        <div class="team">
                            <h3>${team} (${doctors.length}/${TEAM_REQUIREMENTS[team]})</h3>
                            <p><strong>Consultants:</strong> ${CONSULTANT_TEAMS[team]?.consultants.join(', ') || ''}</p>
                            <ul>
                                ${doctors.map(doctor => `
                                    <li class="${doctor.preferred ? 'preferred' : ''}">${doctor.name}</li>
                                `).join('')}
                            </ul>
                        </div>
                    `).join('')}
                    
                    <h2>Special Duties</h2>
                    ${Object.entries(currentAllocation.specialDuties).map(([duty, doctors]) => `
                        <div class="team special-duty">
                            <h3>${duty} (${doctors.length}/${SPECIAL_DUTIES[duty]})</h3>
                            <ul>
                                ${doctors.map(doctor => `
                                    <li class="${doctor.preferred ? 'preferred' : ''}">${doctor.name}</li>
                                `).join('')}
                            </ul>
                        </div>
                    `).join('')}
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }
    </script>
</body>
</html>
